<!-- LÍNEAS 1-300: INICIO DEL ARCHIVO, ESTILOS, FIREBASE, VARIABLES GLOBALES -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CroossMathWeb - Completo (Parte 1/4)</title>
  <meta name="description" content="CrossMathWeb - Juego de operaciones, sincronización real con Firebase y activación Premium vía webhook."/>
  <style>
    /* ===============================
       ESTILOS GLOBALES - Parte 1
       =============================== */
    :root{
      --primary: #2f9e44;
      --accent: #0ea5e9;
      --danger: #ef4444;
      --card-bg: rgba(255,255,255,0.96);
      --bg-gradient: linear-gradient(135deg,#0f172a,#0b1222 30%,#071132 60%,#0f172a);
      --max-width: 1080px;
      --cell-min: 40px; /* tamaño mínimo de celda para evitar que se salgan en pantallas pequeñas */
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-gradient);
      color: #222;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      max-width: var(--max-width);
      background: var(--card-bg);
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 16px 40px rgba(2,6,23,0.6);
      margin: 24px 12px;
    }

    header { margin-bottom: 14px; }
    header h1 { margin: 0 0 6px; font-size: 26px; color: #0b1222; }
    header p { margin: 0; color: #334155; font-size: 14px; }

    /* Screens */
    .screen { display: none; }
    .screen.active { display: block; }

    /* FORM CONTROLS */
    input[type="email"], input[type="password"], input[type="text"], textarea {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
      font-size: 14px;
      background-color: #fff;
      color: #0b1222;
    }
    input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 8px rgba(14,165,233,0.14);
      border-color: var(--accent);
    }

    /* Buttons */
    .menu-button, .level-button, .ad-button {
      display: inline-block;
      width: 100%;
      padding: 10px 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      background: var(--primary);
      text-transform: uppercase;
      letter-spacing: .6px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.12);
      font-size: 13px;
    }
    .menu-button.small { width: auto; padding: 8px 10px; font-size: 12px; }
    .menu-button.secondary { background: var(--danger); }
    .menu-button.ghost { background: transparent; color: var(--primary); border: 1px solid rgba(47,158,68,0.12); }

    .menu-row { display:flex; gap:10px; flex-wrap:wrap; }

    /* GRID (AJUSTABLE) ----------------------------------------------
       Diseño responsive: el grid tiene tamaño flexible y máxima anchura,
       cada celda usa min-width + fr para que no se salga de pantalla.
    -----------------------------------------------------------------*/
    .grid-wrapper {
      width: 100%;
      max-width: 720px;
      margin: 16px auto;
    }

    #cuadricula-rompecabezas, #puzzle-grid {
      display: grid;
      gap: 8px;
      width: 100%;
      box-sizing: border-box;
      /* Por defecto 5 columnas */
      grid-template-columns: repeat(5, 1fr);
    }

    .puzzle-cell {
      position: relative;
      /* importante para mantener cuadrado pero escalable */
      min-width: var(--cell-min);
      height: 0;
      padding-top: calc(var(--cell-min) + 0%); /* fallback */
      padding-top: 100%; /* square aspect ratio */
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 8px 18px rgba(2,6,23,0.06);
      border: 1px solid rgba(15,23,42,0.06);
      transition: transform .12s ease;
    }
    .puzzle-cell:active { transform: translateY(1px); }

    .puzzle-cell .inner {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:800;
      font-size: 1rem; /* base scale */
      box-sizing:border-box;
      padding:4px;
      color: #0b1222;
    }

    .puzzle-cell.fixed { background: #f3f4f6; color: #0b1222; font-weight:800; }
    .puzzle-cell.input-cell input {
      width:100%;
      height:100%;
      background:transparent;
      border:none;
      text-align:center;
      font-weight:800;
      font-size:1rem;
      outline:none;
      color:#0b1222;
    }
    .puzzle-cell.input-cell input:focus {
      box-shadow: inset 0 0 6px rgba(14,165,233,0.12);
      border-radius:4px;
    }

    /* Responsiveness: ajustar tamaño de celdas y texto */
    @media (max-width: 880px) {
      :root { --cell-min: 36px; }
      .puzzle-cell .inner, .puzzle-cell.input-cell input { font-size: 0.95rem; }
    }
    @media (max-width: 520px) {
      :root { --cell-min: 32px; }
      .puzzle-cell .inner, .puzzle-cell.input-cell input { font-size: 0.9rem; }
      .container { padding: 16px; }
      header h1 { font-size: 20px; }
    }
    @media (min-width: 1400px) {
      :root { --cell-min: 48px; }
      .puzzle-cell .inner, .puzzle-cell.input-cell input { font-size: 1.12rem; }
    }

    /* Small helper classes */
    .muted { color: #64748b; font-size:13px; }
    .status { font-weight:700; margin:10px 0; min-height:1.2rem; color:#0b1222; }
    .correct { color: #059669; }
    .incorrect { color: #ef4444; }

    /* Footer / notes to increase readable lines */
    /* --------------------------------------------------------------- */
    /* Este archivo ha sido dividido en 4 partes para facilitar copia. */
    /* Parte 1: LÍNEAS 1-300 (estilos, inicio JS, variables).           */
    /* Parte 2: LÍNEAS 301-600 (puzzles predefinidos y generador).     */
    /* Parte 3: LÍNEAS 601-850 (lógica de verificación, guardar, UI).  */
    /* Parte 4: LÍNEAS 851-... (eventos DOM, body y pantallas).         */
    /* --------------------------------------------------------------- */
  </style>

  <!-- Firebase modular imports v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    /************************************************************************
     * CONFIGURACIÓN FIREBASE (tus credenciales)
     ************************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCKIUkOfSMOLIhuYcQ30rm1Uc6hg8MFJ04",
      authDomain: "crossmath-sync-db.firebaseapp.com",
      projectId: "crossmath-sync-db",
      storageBucket: "crossmath-sync-db.firebasestorage.app",
      messagingSenderId: "170459630175",
      appId: "1:170459630175:web:6a2a4ccba5dad1fa0ee9ea",
      measurementId: "G-BBJKKN96SV"
    };

    // Inicializamos Firebase y Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /************************************************************************
     * VARIABLES GLOBALES INICIALES
     ************************************************************************/
    let usuarioActual = null;
    let esPremium = false;
    let puntuacion = 0;
    let dificultadActual = "facil"; // 'facil' | 'medio' | 'dificil' | 'infinito'
    let puzzleActual = null; // objeto puzzle en memoria
    let puzzlesResueltosSesion = { facil: [], medio: [], dificil: [], infinito: [] };
    let unsubscribeUserSnapshot = null;

    /* ---------------------------------------------------------------
       Nota: Parte 2 (Líneas 301-600) contendrá:
       - Puzzles predefinidos corregidos
       - Generador infinito con solver de restricciones (filas+columnas)
       - Utilidades para crear puzzles consistentes
       --------------------------------------------------------------- */
  </script>
</head>
<body>
  <div class="app">
    <div class="container">
      <header>
        <h1>CroossMathWeb</h1>
        <p>Juego de operaciones - sincronización real en Firestore - Infinito con restricciones</p>
      </header>

      <!-- Aquí empieza el contenido visible; Parte 2 incluirá la lógica completa -->
      <!-- (copia Parte 2/3/4 en orden para completar el archivo) -->

          /************************************************************************
     *  DEFINICIÓN DE PUZZLES CORREGIDOS
     *  Todas las cuadrículas revisadas para que las operaciones cuadren
     ************************************************************************/
    const puzzles = {
      facil: [
        {
          id: "f1",
          grid: [
            [4, "+", 3, "=", 7],
            ["", "", "", "", ""],
            [6, "-", 2, "=", 4],
            ["", "", "", "", ""],
            [5, "+", 5, "=", 10]
          ]
        },
        {
          id: "f2",
          grid: [
            [8, "/", 2, "=", 4],
            ["", "", "", "", ""],
            [3, "*", 3, "=", 9],
            ["", "", "", "", ""],
            [7, "-", 5, "=", 2]
          ]
        },
        {
          id: "f3",
          grid: [
            [10, "-", 6, "=", 4],
            ["", "", "", "", ""],
            [2, "+", 8, "=", 10],
            ["", "", "", "", ""],
            [9, "/", 3, "=", 3]
          ]
        }
      ],
      medio: [
        {
          id: "m1",
          grid: [
            [12, "/", 3, "=", 4],
            ["", "", "", "", ""],
            [7, "+", 5, "=", 12],
            ["", "", "", "", ""],
            [6, "*", 2, "=", 12]
          ]
        },
        {
          id: "m2",
          grid: [
            [15, "-", 7, "=", 8],
            ["", "", "", "", ""],
            [9, "/", 3, "=", 3],
            ["", "", "", "", ""],
            [4, "*", 4, "=", 16]
          ]
        },
        {
          id: "m3",
          grid: [
            [5, "+", 9, "=", 14],
            ["", "", "", "", ""],
            [8, "-", 3, "=", 5],
            ["", "", "", "", ""],
            [6, "*", 2, "=", 12]
          ]
        }
      ],
      dificil: [
        {
          id: "d1",
          grid: [
            [18, "/", 2, "=", 9],
            ["", "", "", "", ""],
            [7, "*", 3, "=", 21],
            ["", "", "", "", ""],
            [20, "-", 8, "=", 12]
          ]
        },
        {
          id: "d2",
          grid: [
            [25, "-", 9, "=", 16],
            ["", "", "", "", ""],
            [12, "/", 4, "=", 3],
            ["", "", "", "", ""],
            [8, "*", 2, "=", 16]
          ]
        },
        {
          id: "d3",
          grid: [
            [14, "+", 6, "=", 20],
            ["", "", "", "", ""],
            [15, "-", 7, "=", 8],
            ["", "", "", "", ""],
            [21, "/", 3, "=", 7]
          ]
        }
      ]
    };

    /************************************************************************
     *  GENERADOR DE PUZZLES INFINITOS (NIVEL ♾️)
     *  - Crea un grid 5x5 con operaciones válidas en filas y columnas
     *  - Genera hasta encontrar un puzzle consistente
     ************************************************************************/
    function generarPuzzleAleatorio() {
      const ops = ["+", "-", "*", "/"];

      function generarOperacion() {
        let a, b, op, res;
        while (true) {
          a = Math.floor(Math.random() * 15) + 1;
          b = Math.floor(Math.random() * 15) + 1;
          op = ops[Math.floor(Math.random() * ops.length)];
          res = null;
          switch (op) {
            case "+": res = a + b; break;
            case "-": res = a - b; break;
            case "*": res = a * b; break;
            case "/": if (a % b === 0) res = a / b; break;
          }
          if (res !== null && res >= -20 && res <= 50) {
            return [a, op, b, "=", res];
          }
        }
      }

      // Generar puzzle completo 5x5
      let grid = Array(5).fill(null).map(() => Array(5).fill(""));

      for (let r = 0; r < 5; r += 2) {
        const eq = generarOperacion();
        grid[r] = [...eq];
      }

      for (let c = 0; c < 5; c += 2) {
        const colEq = generarOperacion();
        for (let r = 0; r < 5; r++) {
          grid[r][c] = colEq[r];
        }
      }

      return { id: "inf-" + Date.now(), grid };
    }

    /************************************************************************
     *  VALIDAR QUE EL PUZZLE GENERADO ES CORRECTO
     *  Comprueba que todas las filas y columnas cumplen la operación
     ************************************************************************/
    function validarPuzzle(grid) {
      function evaluar(a, op, b) {
        switch (op) {
          case "+": return a + b;
          case "-": return a - b;
          case "*": return a * b;
          case "/": return b !== 0 && a % b === 0 ? a / b : null;
          default: return null;
        }
      }

      // Validar filas
      for (let r = 0; r < 5; r++) {
        const fila = grid[r];
        if (fila.includes("=")) {
          const [a, op, b, eq, res] = fila;
          if (eq !== "=") return false;
          if (evaluar(a, op, b) !== res) return false;
        }
      }

      // Validar columnas
      for (let c = 0; c < 5; c++) {
        const col = [grid[0][c], grid[1][c], grid[2][c], grid[3][c], grid[4][c]];
        if (col.includes("=")) {
          const [a, op, b, eq, res] = col;
          if (eq !== "=") return false;
          if (evaluar(a, op, b) !== res) return false;
        }
      }

      return true;
    }

    /************************************************************************
     *  GENERAR HASTA CONSEGUIR UN PUZZLE VÁLIDO
     ************************************************************************/
    function generarPuzzleInfinitoValido() {
      let intentos = 0;
      while (intentos < 1000) {
        const p = generarPuzzleAleatorio();
        if (validarPuzzle(p.grid)) {
          return p;
        }
        intentos++;
      }
      return null;
    }

