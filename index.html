<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CroossMathWeb — Versión Local</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1320;
      --card: #141a2f;
      --accent: #4cc9f0;
      --accent-2: #7b2cbf;
      --text: #e9edf7;
      --muted: #a8b0c4;
      --ok: #27ae60;
      --warn: #f39c12;
      --err: #e74c3c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b0e1a, var(--bg));
      color: var(--text);
      min-height: 100vh;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid #1f2540; background: #0d1120cc; backdrop-filter: blur(8px);
      position: sticky; top: 0; z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 32px; height: 32px; border-radius: 8px;
      background: conic-gradient(from 180deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 16px rgba(76,201,240,0.35);
    }
    .title { font-weight: 700; letter-spacing: 0.3px; }
    .user-bar { display: flex; align-items: center; gap: 8px; color: var(--muted); }
    button, .btn {
      background: var(--accent); color: #071018; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer;
      box-shadow: 0 8px 18px rgba(76,201,240,0.25); transition: transform 0.05s ease, filter 0.2s ease;
    }
    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    .btn-secondary {
      background: #253058; color: var(--text); box-shadow: none; border: 1px solid #2e3a6a;
    }

    main { max-width: 980px; margin: 20px auto; padding: 0 16px 40px; }
    .card {
      background: linear-gradient(180deg, var(--card), #111630);
      border: 1px solid #1f2540; border-radius: 16px; padding: 16px; margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(17,22,48,0.35);
    }
    h2, h3 { margin: 10px 0 12px; }
    .muted { color: var(--muted); font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .input, input, select {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a325a; background: #0e132a; color: var(--text);
    }
    .kbd { display: inline-block; background: #0e132a; border: 1px solid #2a325a; color: var(--muted); padding: 2px 6px; border-radius: 6px; font-size: 12px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #2a325a; color: var(--muted); }
    .message { padding: 10px 12px; border-radius: 12px; font-size: 14px; }
    .ok { background: #12251a; border: 1px solid #1f7a47; color: #b6f3cf; }
    .warn { background: #251f12; border: 1px solid #7a5b1f; color: #f6deb1; }
    .err { background: #2a1515; border: 1px solid #7a1f1f; color: #f7b6b6; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(5,8,20,0.65); backdrop-filter: blur(2px);
      display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal {
      width: 100%; max-width: 460px; background: linear-gradient(180deg, #101734, #0c122d);
      border: 1px solid #222a4e; border-radius: 16px; padding: 16px;
      box-shadow: 0 20px 50px rgba(10,15,35,0.55);
    }
    .modal header { position: static; padding: 0; background: transparent; border: none; margin-bottom: 10px; }
    .modal .actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
    .hidden { display: none !important; }

    /* Exercise UI */
    .exercise {
      display: grid; grid-template-columns: 1fr; gap: 10px; align-items: start;
    }
    .progress-list { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .progress-item {
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      padding: 8px 10px; border-radius: 12px; border: 1px solid #21335a; background: #0d1330;
    }
    .footer-note { margin-top: 18px; font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">CroossMathWeb — Local</div>
      <span class="pill">Solo dispositivo</span>
    </div>
    <div class="user-bar">
      <span id="userStatus" class="muted">Sin sesión</span>
      <button id="loginBtn">Iniciar sesión</button>
      <button id="logoutBtn" class="btn-secondary hidden">Cerrar sesión</button>
    </div>
  </header>

  <main>
    <!-- Sección protegida por middleware -->
    <section id="protectedArea" class="hidden">
      <div class="card">
        <h2>Panel de usuario</h2>
        <p class="muted">Aquí gestionas tus ejercicios y tu progreso local. Este contenido requiere sesión activa.</p>
        <div class="row">
          <div class="card">
            <h3>Ejercicio rápido</h3>
            <p class="muted">Resuelve operaciones básicas para registrar avance. Cambia el nivel para ajustar dificultad.</p>
            <div class="exercise">
              <label for="levelSelect">Nivel</label>
              <select id="levelSelect" class="input">
                <option value="1">Nivel 1 (sumas 0–10)</option>
                <option value="2">Nivel 2 (sumas 10–50)</option>
                <option value="3">Nivel 3 (sumas y restas 0–100)</option>
              </select>
              <div id="exerciseProblem" class="message warn">Presiona “Nuevo” para generar un problema.</div>
              <div class="flex">
                <button id="newProblemBtn">Nuevo</button>
                <input id="answerInput" class="input" type="number" placeholder="Tu respuesta" />
                <button id="checkAnswerBtn" class="btn-secondary">Verificar</button>
              </div>
              <div id="exerciseFeedback" class="message hidden"></div>
            </div>
          </div>

          <div class="card">
            <h3>Progreso</h3>
            <p class="muted">Guarda, exporta, importa. La portabilidad es un archivo JSON con tus niveles y puntajes.</p>
            <div class="flex">
              <button id="saveProgressBtn">Guardar progreso</button>
              <button id="exportProgressBtn" class="btn-secondary">Exportar JSON</button>
              <label class="btn" for="importFileInput" style="cursor:pointer;">Importar JSON</label>
              <input id="importFileInput" type="file" accept="application/json" class="hidden" />
            </div>
            <div id="progressStatus" class="message hidden"></div>
            <h4 style="margin-top:12px;">Histórico</h4>
            <div id="progressList" class="progress-list"></div>
            <p class="footer-note">Tip: puedes respaldar tu archivo en tu disco o mandarlo por correo para moverlo a otro dispositivo.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Sección pública -->
    <section id="publicArea">
      <div class="card">
        <h2>Bienvenida</h2>
        <p>Esta es la versión totalmente local de CroossMathWeb. No usa servicios externos. Para comenzar, crea una cuenta local o inicia sesión.</p>
        <div class="flex">
          <button id="getStartedBtn">Crear cuenta</button>
          <span class="muted">Acceso protegido por sesión. Atajos: <span class="kbd">Shift + L</span> abre el modal.</span>
        </div>
      </div>

      <div class="card">
        <h3>Cómo funciona</h3>
        <ul>
          <li><strong>Autenticación local:</strong> tus credenciales se almacenan en IndexedDB con hash de contraseña (Web Crypto).</li>
          <li><strong>Portabilidad:</strong> exporta tu progreso como JSON y restáuralo con importar.</li>
          <li><strong>Middleware de sesión:</strong> sin sesión, no ves el panel de usuario; con sesión, todo habilitado.</li>
          <li><strong>Sin internet:</strong> todo corre en tu navegador, sin llamadas a la nube.</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- Modal de Login/Registro -->
  <div id="authModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="authModalTitle" aria-modal="true">
      <header>
        <h3 id="authModalTitle">Acceso local</h3>
        <p class="muted">Crea una cuenta o inicia sesión. Tus datos se quedan en tu dispositivo.</p>
      </header>
      <div class="row">
        <div>
          <label for="usernameInput">Usuario</label>
          <input id="usernameInput" class="input" type="text" placeholder="ej. ana_local" autocomplete="username" />
        </div>
        <div>
          <label for="passwordInput">Contraseña</label>
          <input id="passwordInput" class="input" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>
      <div id="authFeedback" class="message hidden"></div>
      <div class="actions">
        <button id="registerBtn" class="btn-secondary">Registrar</button>
        <button id="authLoginBtn">Entrar</button>
        <button id="closeAuthBtn" class="btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // ========= Utilidades Web Crypto para hash de contraseñas =========
    async function hashPassword(password) {
      const enc = new TextEncoder();
      const data = enc.encode(password);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(digest))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // ========= IndexedDB: apertura, stores y helpers =========
    const DB_NAME = 'crossmath-local-db';
    const DB_VERSION = 1;
    let dbInstance = null;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('users')) {
            db.createObjectStore('users', { keyPath: 'username' });
          }
          if (!db.objectStoreNames.contains('progress')) {
            db.createObjectStore('progress', { keyPath: 'username' });
          }
        };
        req.onsuccess = () => {
          dbInstance = req.result;
          resolve(dbInstance);
        };
        req.onerror = () => reject(req.error);
      });
    }

    function tx(storeName, mode = 'readonly') {
      const tx = dbInstance.transaction(storeName, mode);
      return tx.objectStore(storeName);
    }

    function getUser(username) {
      return new Promise((resolve, reject) => {
        const store = tx('users');
        const req = store.get(username);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    function putUser(user) {
      return new Promise((resolve, reject) => {
        const store = tx('users', 'readwrite');
        const req = store.put(user);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    function getProgress(username) {
      return new Promise((resolve, reject) => {
        const store = tx('progress');
        const req = store.get(username);
        req.onsuccess = () => resolve(req.result || { username, levels: [], lastUpdated: null });
        req.onerror = () => reject(req.error);
      });
    }

    function putProgress(progress) {
      return new Promise((resolve, reject) => {
        const store = tx('progress', 'readwrite');
        const req = store.put(progress);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    // ========= Estado de sesión y middleware =========
    function setSessionUser(username) {
      sessionStorage.setItem('authUser', username);
      updateAuthUI();
    }
    function getSessionUser() {
      return sessionStorage.getItem('authUser');
    }
    function clearSession() {
      sessionStorage.removeItem('authUser');
      updateAuthUI();
    }

    function guardRoutes() {
      const isAuthed = Boolean(getSessionUser());
      document.getElementById('protectedArea').classList.toggle('hidden', !isAuthed);
      document.getElementById('publicArea').classList.toggle('hidden', isAuthed);
    }

    function updateAuthUI() {
      const user = getSessionUser();
      const userStatus = document.getElementById('userStatus');
      const logoutBtn = document.getElementById('logoutBtn');
      const loginBtn = document.getElementById('loginBtn');
      userStatus.textContent = user ? `Sesión: ${user}` : 'Sin sesión';
      logoutBtn.classList.toggle('hidden', !user);
      loginBtn.classList.toggle('hidden', !!user);
      guardRoutes();
      if (user) {
        // Cargar lista de progreso
        renderProgressList(user);
      } else {
        document.getElementById('progressList').innerHTML = '';
      }
    }

    // ========= Modal de autenticación =========
    const authModalBackdrop = document.getElementById('authModalBackdrop');
    const authFeedback = document.getElementById('authFeedback');

    function openAuthModal() {
      authModalBackdrop.style.display = 'flex';
      authModalBackdrop.setAttribute('aria-hidden', 'false');
      authFeedback.classList.add('hidden');
      authFeedback.textContent = '';
    }
    function closeAuthModal() {
      authModalBackdrop.style.display = 'none';
      authModalBackdrop.setAttribute('aria-hidden', 'true');
    }
    function showFeedback(el, msg, type='warn') {
      el.textContent = msg;
      el.classList.remove('hidden', 'ok', 'warn', 'err');
      el.classList.add(type, 'message');
    }

    // ========= Registro e inicio de sesión =========
    async function registerLocalUser(username, password) {
      if (!username || !password) {
        showFeedback(authFeedback, 'Usuario y contraseña son obligatorios.', 'err');
        return;
      }
      const existing = await getUser(username);
      if (existing) {
        showFeedback(authFeedback, 'Ese usuario ya existe. Elige otro o inicia sesión.', 'warn');
        return;
      }
      const passHash = await hashPassword(password);
      const user = { username, passHash, createdAt: new Date().toISOString() };
      await putUser(user);
      // Inicializa progreso vacío
      await putProgress({ username, levels: [], lastUpdated: new Date().toISOString() });
      showFeedback(authFeedback, 'Usuario creado. Ya puedes iniciar sesión.', 'ok');
    }

    async function loginLocalUser(username, password) {
      if (!username || !password) {
        showFeedback(authFeedback, 'Usuario y contraseña son obligatorios.', 'err');
        return;
      }
      const user = await getUser(username);
      if (!user) {
        showFeedback(authFeedback, 'Usuario no encontrado. Regístrate primero.', 'warn');
        return;
      }
      const passHash = await hashPassword(password);
      if (passHash !== user.passHash) {
        showFeedback(authFeedback, 'Contraseña incorrecta.', 'err');
        return;
      }
      setSessionUser(username);
      closeAuthModal();
    }

    // ========= Núcleo de ejercicios matemáticos =========
    let currentProblem = null;

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateProblem(level) {
      if (level === '1') {
        const a = randInt(0, 10), b = randInt(0, 10);
        return { text: `${a} + ${b} = ?`, answer: a + b, kind: 'sum' };
      }
      if (level === '2') {
        const a = randInt(10, 50), b = randInt(10, 50);
        return { text: `${a} + ${b} = ?`, answer: a + b, kind: 'sum' };
      }
      // level 3: sumas y restas 0–100
      const a = randInt(0, 100), b = randInt(0, 100);
      const op = Math.random() < 0.5 ? '+' : '-';
      const ans = op === '+' ? a + b : a - b;
      return { text: `${a} ${op} ${b} = ?`, answer: ans, kind: op === '+' ? 'sum' : 'sub' };
    }

    async function recordAttempt(isCorrect) {
      const user = getSessionUser();
      if (!user) return;
      const level = document.getElementById('levelSelect').value;
      const progress = await getProgress(user);
      // Busca nivel
      const idx = progress.levels.findIndex(l => String(l.id) === String(level));
      const now = new Date().toISOString();
      if (idx === -1) {
        progress.levels.push({ id: level, attempts: 1, correct: isCorrect ? 1 : 0, lastPlayed: now });
      } else {
        const l = progress.levels[idx];
        l.attempts += 1;
        l.correct += isCorrect ? 1 : 0;
        l.lastPlayed = now;
      }
      progress.lastUpdated = now;
      await putProgress(progress);
      renderProgressList(user);
    }

    async function renderProgressList(username) {
      const container = document.getElementById('progressList');
      const progress = await getProgress(username);
      if (!progress.levels.length) {
        container.innerHTML = '<div class="message warn">Sin registros aún. Juega y guarda para ver tu histórico.</div>';
        return;
      }
      container.innerHTML = '';
      progress.levels
        .sort((a, b) => Number(a.id) - Number(b.id))
        .forEach(lvl => {
          const acc = lvl.attempts ? Math.round((lvl.correct / lvl.attempts) * 100) : 0;
          const div = document.createElement('div');
          div.className = 'progress-item';
          div.innerHTML = `
            <span class="pill">Nivel ${lvl.id}</span>
            <div class="muted">Intentos: ${lvl.attempts} · Correctos: ${lvl.correct} · Precisión: ${acc}%</div>
            <span class="kbd">${new Date(lvl.lastPlayed).toLocaleString()}</span>
          `;
          container.appendChild(div);
        });
    }

    // ========= Guardar, Exportar e Importar progreso =========
    async function saveProgress() {
      const user = getSessionUser();
      if (!user) return;
      const progressStatus = document.getElementById('progressStatus');
      const progress = await getProgress(user);
      progress.lastUpdated = new Date().toISOString();
      await putProgress(progress);
      showFeedback(progressStatus, 'Progreso guardado localmente.', 'ok');
      setTimeout(() => progressStatus.classList.add('hidden'), 1800);
    }

    async function exportProgress() {
      const user = getSessionUser();
      if (!user) return;
      const progress = await getProgress(user);
      const payload = {
        schema: 'croossmathweb.local.v1',
        user,
        progress
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const dateStr = new Date().toISOString().replace(/[:.]/g, '-');
      a.download = `croossmath_progress_${user}_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      const progressStatus = document.getElementById('progressStatus');
      showFeedback(progressStatus, 'Exportación completada. Archivo descargado.', 'ok');
      setTimeout(() => progressStatus.classList.add('hidden'), 2000);
    }

    async function importProgressFile(file) {
      const progressStatus = document.getElementById('progressStatus');
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || data.schema !== 'croossmathweb.local.v1' || !data.user || !data.progress) {
          showFeedback(progressStatus, 'Archivo inválido o esquema desconocido.', 'err');
          return;
        }
        const currentUser = getSessionUser();
        if (!currentUser) {
          showFeedback(progressStatus, 'Inicia sesión para importar progreso.', 'warn');
          return;
        }
        if (data.user !== currentUser) {
          showFeedback(progressStatus, 'El archivo pertenece a otro usuario. Usa esa sesión o cambia el nombre en el archivo bajo tu responsabilidad.', 'warn');
          return;
        }
        // Fusión simple: reemplaza progreso existente por importado
        const imported = data.progress;
        imported.username = currentUser;
        imported.lastUpdated = new Date().toISOString();
        await putProgress(imported);
        renderProgressList(currentUser);
        showFeedback(progressStatus, 'Importación exitosa. Histórico actualizado.', 'ok');
        setTimeout(() => progressStatus.classList.add('hidden'), 2000);
      } catch (e) {
        showFeedback(progressStatus, 'Error al importar: archivo corrupto o no válido.', 'err');
      }
    }

    // ========= Listeners de UI =========
    document.getElementById('loginBtn').addEventListener('click', openAuthModal);
    document.getElementById('getStartedBtn').addEventListener('click', openAuthModal);
    document.getElementById('closeAuthBtn').addEventListener('click', closeAuthModal);
    document.getElementById('logoutBtn').addEventListener('click', () => { clearSession(); });

    document.getElementById('registerBtn').addEventListener('click', async () => {
      const u = document.getElementById('usernameInput').value.trim();
      const p = document.getElementById('passwordInput').value;
      await registerLocalUser(u, p);
    });
    document.getElementById('authLoginBtn').addEventListener('click', async () => {
      const u = document.getElementById('usernameInput').value.trim();
      const p = document.getElementById('passwordInput').value;
      await loginLocalUser(u, p);
    });

    // Atajo de teclado: Shift+L abre login
    window.addEventListener('keydown', (e) => {
      if (e.shiftKey && e.key.toLowerCase() === 'l') openAuthModal();
    });

    // Ejercicios
    const exerciseProblem = document.getElementById('exerciseProblem');
    const answerInput = document.getElementById('answerInput');
    const exerciseFeedback = document.getElementById('exerciseFeedback');

    document.getElementById('newProblemBtn').addEventListener('click', () => {
      const level = document.getElementById('levelSelect').value;
      currentProblem = generateProblem(level);
      exerciseProblem.textContent = currentProblem.text;
      exerciseProblem.classList.remove('err', 'ok');
      exerciseProblem.classList.add('warn');
      exerciseFeedback.classList.add('hidden');
      answerInput.value = '';
      answerInput.focus();
    });

    document.getElementById('checkAnswerBtn').addEventListener('click', async () => {
      if (!currentProblem) {
        exerciseFeedback.classList.remove('hidden');
        showFeedback(exerciseFeedback, 'Primero genera un problema con “Nuevo”.', 'warn');
        return;
      }
      const val = Number(answerInput.value);
      if (Number.isNaN(val)) {
        exerciseFeedback.classList.remove('hidden');
        showFeedback(exerciseFeedback, 'Ingresa una respuesta válida.', 'err');
        return;
      }
      const correct = val === currentProblem.answer;
      if (correct) {
        showFeedback(exerciseFeedback, '¡Correcto! Registrado en tu progreso.', 'ok');
        await recordAttempt(true);
      } else {
        showFeedback(exerciseFeedback, `Incorrecto. La respuesta era ${currentProblem.answer}.`, 'err');
        await recordAttempt(false);
      }
      currentProblem = null;
      exerciseProblem.classList.remove('warn');
      exerciseProblem.textContent = 'Presiona “Nuevo” para generar un problema.';
    });

    // Progreso: guardar, exportar, importar
    document.getElementById('saveProgressBtn').addEventListener('click', saveProgress);
    document.getElementById('exportProgressBtn').addEventListener('click', exportProgress);
    document.getElementById('importFileInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (file) await importProgressFile(file);
      e.target.value = '';
    });

    // ========= Inicialización =========
    (async function init() {
      await openDB();
      updateAuthUI();
    })();
  </script>
</body>
</html>
