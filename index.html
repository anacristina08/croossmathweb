<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CroossMathWeb - Corregido y Completo</title>
  <meta name="description" content="CrossMathWeb - Juego de operaciones, sincronización real con Firebase y activación Premium vía webhook."/>
  <style>
    /* ===============================
       Estilos completos y corregidos
       =============================== */
    :root{
      --primary: #4CAF50;
      --danger: #f44336;
      --card-bg: rgba(255,255,255,0.95);
      --bg-gradient: linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);
      --max-width: 980px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-gradient);
      color: #333;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: var(--max-width);
      background: var(--card-bg);
      border-radius: 14px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
      position: relative;
      overflow: hidden;
    }
    header h1 { margin: 0 0 8px; font-size: 28px; }
    header p { margin: 0 0 18px; color: #555; }

    /* Screens */
    .screen { display: none; }
    .screen.active { display: block; }

    /* Forms & inputs */
    input[type="email"], input[type="password"], input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 15px;
      background-color: #f9f9f9;
    }
    input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 8px rgba(76,175,80,0.25);
      border-color: var(--primary);
    }

    /* Buttons */
    .menu-button, .level-button, .ad-button {
      display: inline-block;
      width: 100%;
      padding: 12px 14px;
      margin: 8px 0;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      background: var(--primary);
      text-transform: uppercase;
      letter-spacing: .5px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    .menu-button.secondary {
      background: var(--danger);
    }
    .menu-button:active { transform: translateY(1px); }
    .menu-row { display: flex; gap: 12px; }

    /* Puzzle grid */
    #puzzle-grid {
      margin: 18px auto;
      display: grid;
      gap: 8px;
      width: 100%;
      max-width: 620px;
      transform: rotateX(3deg);
    }
    .puzzle-cell {
      position: relative;
      padding-top: 100%; /* cuadrado */
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
    }
    .puzzle-cell .inner {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:700;
      font-size:1.35rem;
      box-sizing:border-box;
      padding:6px;
    }
    .puzzle-cell.fixed { background: #f0f0f0; color: #333; }
    .puzzle-cell.input-cell input {
      width:100%;
      height:100%;
      background:transparent;
      border:none;
      text-align:center;
      font-weight:700;
      font-size:1.1rem;
      outline:none;
    }
    .puzzle-cell.input-cell input:focus {
      box-shadow: inset 0 0 6px rgba(76,175,80,0.25);
      border-radius:4px;
    }

    /* Ad popup */
    .ad-screen {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.9);
      color: #fff;
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
    }
    .ad-card {
      background: #222;
      max-width: 420px;
      width: 100%;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      text-align:center;
    }
    .status { font-weight:700; margin:10px 0; min-height:1.2rem; }

    /* responsive */
    @media (min-width: 900px) {
      header h1 { font-size: 36px; }
      .puzzle-cell .inner { font-size: 1.6rem; }
    }
  </style>
  <!-- Firebase modular imports v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    /************************************************************************
     *  CONFIGURACIÓN REAL DE FIREBASE (proporcionada por ti)
     ************************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCKIUkOfSMOLIhuYcQ30rm1Uc6hg8MFJ04",
      authDomain: "crossmath-sync-db.firebaseapp.com",
      projectId: "crossmath-sync-db",
      storageBucket: "crossmath-sync-db.firebasestorage.app",
      messagingSenderId: "170459630175",
      appId: "1:170459630175:web:6a2a4ccba5dad1fa0ee9ea",
      measurementId: "G-BBJKKN96SV"
    };

    // Inicializamos Firebase y Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /************************************************************************
     *  VARIABLES GLOBALES DE LA APLICACIÓN
     *  - Mantengo nombres en español para que concuerde con tu archivo original
     ************************************************************************/
    let usuarioActual = null;
    let esPremium = false;
    let puntuacion = 0;
    let dificultadActual = "facil"; // 'facil', 'medio', 'dificil'
    let puzzleActual = null;
    let puzzlesResueltosSesion = { facil: [], medio: [], dificil: [] };
    let unsubscribeUserSnapshot = null;

    /************************************************************************
     *  Puzzles (estructura 5x5 - cada fila/columna puede describir una ecuación)
     *
     *  He conservado y corregido las definiciones que tenías, arreglando
     *  sintaxis y nombres para evitar errores.
     ************************************************************************/
    const puzzles = {
      facil: [
        {
          id: "e1",
          grid: [
            [8, "/", null, "=", 2],
            ["+", "", "-", "", ""],
            [2, "+", 3, "=", null],
            ["=", "", "", "", "="],
            [null, "", 1, "", 10]
          ]
        },
        {
          id: "e2",
          grid: [
            [5, "+", null, "=", 12],
            ["-", "", "", "*", ""],
            [3, "*", 4, "=", null],
            ["=", "", "", "", "="],
            [null, "", 7, "", 15]
          ]
        },
        {
          id: "e3",
          grid: [
            [10, "-", null, "=", 3],
            ["*", "", "+", "", "/"],
            [2, "+", 5, "=", null],
            ["=", "", "", "", "="],
            [null, "", 8, "", 4]
          ]
        }
      ],
      medio: [
        {
          id: "m1",
          grid: [
            [null, "*", 3, "=", 21],
            ["-", "", "+", "", "/"],
            [4, "*", null, "=", 32],
            ["=", "", "", "", "="],
            [3, "", 11, "", null]
          ]
        },
        {
          id: "m2",
          grid: [
            [7, "+", null, "=", 15],
            ["/", "", "-", "", "*"],
            [6, "-", 2, "=", null],
            ["=", "", "", "", "="],
            [null, "", 9, "", 18]
          ]
        },
        {
          id: "m3",
          grid: [
            [null, "*", 5, "=", 30],
            ["+", "", "", "/", ""],
            [8, "/", null, "=", 4],
            ["=", "", "", "", "="],
            [2, "", 10, "", null]
          ]
        }
      ],
      dificil: [
        {
          id: "h1",
          grid: [
            [9, "-", null, "=", 2],
            ["*", "", "+", "", "*"],
            [null, "/", 3, "=", 3],
            ["=", "", "", "", "="],
            [81, "", 12, "", null]
          ]
        },
        {
          id: "h2",
          grid: [
            [null, "*", 6, "=", 42],
            ["-", "", "+", "", "/"],
            [5, "+", null, "=", 19],
            ["=", "", "", "", "="],
            [7, "", 13, "", null]
          ]
        },
        {
          id: "h3",
          grid: [
            [12, "/", null, "=", 4],
            ["+", "", "*", "", "-"],
            [null, "*", 5, "=", 20],
            ["=", "", "", "", "="],
            [3, "", 15, "", null]
          ]
        }
      ]
    };

    /************************************************************************
     * UTILIDADES
     ************************************************************************/
    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const el = document.getElementById(id);
      if (el) el.classList.add("active");
    }

    function actualizarEstadoPremiumUI() {
      const el = document.getElementById("estado-premium");
      if (!el) return;
      el.textContent = esPremium ? "Estado Premium: Premium ✨" : "Estado Premium: No Premium";
      el.style.color = esPremium ? "var(--primary)" : "var(--danger)";
    }

    function crearUsuarioDemoSiNoExiste() {
      // Usuario demo con premium activado
      const demoKey = "user:premium_demo@crossmath.com";
      if (!localStorage.getItem(demoKey)) {
        const demoData = {
          password: "demo123",
          isPremium: true,
          score: 0,
          puzzlesSolved: { facil: [], medio: [], dificil: [] }
        };
        localStorage.setItem(demoKey, JSON.stringify(demoData));
        // Intentar subir a Firestore (no obligatorio; puede fallar si rules lo impiden)
        setDoc(doc(db, "usuarios", "premium_demo@crossmath.com"), demoData, { merge: true })
          .catch(err => console.warn("No se pudo crear demo en Firestore (puede no tener permisos):", err.message));
        console.log("Usuario demo creado localmente: premium_demo@crossmath.com / demo123");
      }
    }

    /************************************************************************
     * AUTENTICACIÓN (localStorage + sincronización mínima con Firestore)
     *
     * Nota: para producción sería ideal usar Firebase Auth; aquí respetamos
     * tu estructura original que guardaba credenciales en localStorage y Firestore.
     ************************************************************************/
    function registrarUsuario(email, password) {
      if (!email || !password) {
        alert("Email y contraseña son requeridos para registrar.");
        return false;
      }
      const key = "user:" + email;
      if (localStorage.getItem(key)) {
        alert("Ese correo ya está registrado.");
        return false;
      }
      const userData = {
        password,
        isPremium: false,
        score: 0,
        puzzlesSolved: { facil: [], medio: [], dificil: [] }
      };
      localStorage.setItem(key, JSON.stringify(userData));
      // intentar guardar en Firestore
      setDoc(doc(db, "usuarios", email), userData, { merge: true })
        .then(() => console.log("Usuario registrado en Firestore:", email))
        .catch(err => console.warn("Advertencia: no se pudo guardar en Firestore:", err.message));
      alert("Cuenta creada. Ahora puedes iniciar sesión.");
      return true;
    }

    function autenticar(email, password) {
      const key = "user:" + email;
      const raw = localStorage.getItem(key);
      if (!raw) return false;
      try {
        const u = JSON.parse(raw);
        if (u.password !== password) return false;
        usuarioActual = email;
        esPremium = !!u.isPremium;
        puntuacion = u.score || 0;
        puzzlesResueltosSesion = u.puzzlesSolved || { facil: [], medio: [], dificil: [] };
        document.getElementById("mensaje-bienvenida").textContent = `Bienvenido, ${email}`;
        actualizarEstadoPremiumUI();
        // Adjuntar listener real-time para cambios en Firestore (p. ej. webhook Gumroad)
        attachRealtimeListener(email);
        return true;
      } catch (e) {
        console.error("Error parseando usuario local:", e);
        return false;
      }
    }

    function cerrarSesion() {
      usuarioActual = null;
      esPremium = false;
      puntuacion = 0;
      puzzlesResueltosSesion = { facil: [], medio: [], dificil: [] };
      if (unsubscribeUserSnapshot) {
        unsubscribeUserSnapshot();
        unsubscribeUserSnapshot = null;
      }
      document.getElementById("auth-email").value = "";
      document.getElementById("auth-password").value = "";
      document.getElementById("auth-status-msg").textContent = "";
      document.getElementById("mensaje-bienvenida").textContent = "";
      actualizarEstadoPremiumUI();
      showScreen("pantalla-auth");
    }

    async function loadProgressFromCloud(email) {
      try {
        const userRef = doc(db, "usuarios", email);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          // actualizar localStorage
          const key = "user:" + email;
          const localData = JSON.parse(localStorage.getItem(key) || "{}");
          const merged = {
            password: localData.password || data.password || localData.password || "",
            isPremium: data.isPremium ?? localData.isPremium ?? false,
            score: data.score ?? localData.score ?? 0,
            puzzlesSolved: data.puzzlesSolved ?? localData.puzzlesSolved ?? { facil: [], medio: [], dificil: [] }
          };
          localStorage.setItem(key, JSON.stringify(merged));
          // actualizar estado actual si es el usuario logueado
          if (usuarioActual === email) {
            esPremium = merged.isPremium;
            puntuacion = merged.score;
            puzzlesResueltosSesion = merged.puzzlesSolved;
            actualizarEstadoPremiumUI();
            document.getElementById("mensaje-bienvenida").textContent = `Bienvenido, ${email}`;
          }
        } else {
          console.log("No hay datos en Firestore para", email);
        }
      } catch (err) {
        console.warn("Error cargando desde Firestore:", err.message);
      }
    }

    function attachRealtimeListener(email) {
      try {
        if (unsubscribeUserSnapshot) unsubscribeUserSnapshot();
        const userRef = doc(db, "usuarios", email);
        unsubscribeUserSnapshot = onSnapshot(userRef, (snap) => {
          if (!snap.exists()) return;
          const data = snap.data();
          // actualizar isPremium si cambió (por webhook)
          if (typeof data.isPremium !== "undefined" && data.isPremium !== esPremium) {
            esPremium = !!data.isPremium;
            actualizarEstadoPremiumUI();
            if (esPremium) {
              alert("Tu cuenta ha sido activada como Premium. ¡Gracias por tu compra!");
            }
          }
          // actualizar score/puzzles en caso de cambios
          if (typeof data.score !== "undefined") puntuacion = data.score;
          if (data.puzzlesSolved) puzzlesResueltosSesion = data.puzzlesSolved;
        }, (err) => {
          console.warn("onSnapshot error:", err.message);
        });
      } catch (e) {
        console.warn("No se pudo adjuntar listener:", e.message);
      }
    }

    /************************************************************************
     * FUNCIONES PRINCIPALES DEL JUEGO
     ************************************************************************/
    function getRandomPuzzle(dificultad) {
      const pool = puzzles[dificultad] || [];
      const solved = puzzlesResueltosSesion[dificultad] || [];
      const unsolved = pool.filter(p => !solved.includes(p.id));
      if (unsolved.length === 0) {
        // Si ya resolviste todos en sesión, reiniciamos la lista de resueltos (comportamiento opcional)
        puzzlesResueltosSesion[dificultad] = [];
        // Guardar local para no perderlo
        saveProgressLocal();
        return pool[Math.floor(Math.random() * pool.length)];
      }
      return unsolved[Math.floor(Math.random() * unsolved.length)];
    }

    function renderPuzzle(puzzle) {
      puzzleActual = JSON.parse(JSON.stringify(puzzle)); // copia defensiva
      const gridEl = document.getElementById("cuadricula-rompecabezas");
      gridEl.innerHTML = "";
      const rows = puzzleActual.grid.length;
      const cols = puzzleActual.grid[0].length;
      gridEl.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
      gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const val = puzzleActual.grid[r][c];
          const cell = document.createElement("div");
          cell.classList.add("puzzle-cell");
          const inner = document.createElement("div");
          inner.classList.add("inner");

          if (val === null) {
            // celda editable -> permite multi-dígito, signo negativo y decimales
            cell.classList.add("input-cell");
            const input = document.createElement("input");
            input.type = "text";
            input.setAttribute("data-row", r);
            input.setAttribute("data-col", c);
            input.setAttribute("maxlength", "12");
            input.inputMode = "numeric";
            // Validación en tiempo real: permitir sólo números, '-' y '.'
            input.addEventListener("input", (e) => {
              let v = e.target.value;
              // eliminar espacios
              v = v.replace(/\s+/g, "");
              // permitir: digits, dot, minus
              v = v.replace(/[^0-9\.\-]/g, "");
              // evitar varios guiones
              if ((v.match(/\-/g) || []).length > 1) v = v.replace(/\-/g, "");
              // evitar varios puntos
              const parts = v.split(".");
              if (parts.length > 2) v = parts[0] + "." + parts.slice(1).join("");
              e.target.value = v;
            });
            inner.appendChild(input);
          } else if (val === "") {
            // Celda vacía (sin estilo)
            inner.textContent = "";
          } else {
            // Celda fija (operador, número, '=' o resultado)
            cell.classList.add("fixed");
            inner.textContent = String(val);
          }

          cell.appendChild(inner);
          gridEl.appendChild(cell);
        }
      }
    }

    // Obtiene la matriz con los valores actuales (números o strings)
    function obtenerValoresActuales() {
      const gridNodes = Array.from(document.getElementById("cuadricula-rompecabezas").querySelectorAll(".puzzle-cell"));
      if (gridNodes.length === 0) return [];
      const cols = parseInt(getComputedStyle(document.getElementById("cuadricula-rompecabezas")).gridTemplateColumns.split(" ").length);
      const filas = [];
      let fila = [];
      gridNodes.forEach((cell, idx) => {
        const input = cell.querySelector("input");
        let value = null;
        if (input) {
          const v = input.value.trim();
          if (v === "") value = null;
          else if (/^[-]?\d+(\.\d+)?$/.test(v)) value = parseFloat(v);
          else value = v;
        } else {
          const txt = cell.textContent.trim();
          if (txt === "") value = null;
          else if (/^[-]?\d+(\.\d+)?$/.test(txt)) value = parseFloat(txt);
          else value = txt;
        }
        fila.push(value);
        if ((idx + 1) % cols === 0) {
          filas.push(fila);
          fila = [];
        }
      });
      if (fila.length) filas.push(fila);
      return filas;
    }

    // Evalúa una operación simple (a op b)
    function evaluarOperacion(a, op, b) {
      if (typeof a !== "number" || typeof b !== "number") return { ok: false, calc: null };
      switch (op) {
        case "+": return { ok: true, calc: a + b };
        case "-": return { ok: true, calc: a - b };
        case "*": return { ok: true, calc: a * b };
        case "/": if (b === 0) return { ok: false, calc: null }; return { ok: true, calc: a / b };
        default: return { ok: false, calc: null };
      }
    }

    // Comprueba todas las ecuaciones (horizontales y verticales) que estén completas con '='
    function verificarTodasEcuaciones() {
      if (!puzzleActual) return false;
      const grid = obtenerValoresActuales();
      if (!grid || grid.length === 0) return false;
      const R = grid.length;
      const C = grid[0].length;

      // Revisar filas
      for (let r = 0; r < R; r++) {
        const row = grid[r];
        if (row.includes("=")) {
          // Buscamos el patrón [num, op, num, '=', result] en esa fila
          if (C < 5) return false;
          const num1 = row[0], op = row[1], num2 = row[2], eq = row[3], res = row[4];
          if (num1 === null || op === null || num2 === null || res === null || eq !== "=") return false;
          if (typeof op !== "string") return false;
          const ev = evaluarOperacion(Number(num1), op, Number(num2));
          if (!ev.ok) return false;
          if (Math.abs(ev.calc - Number(res)) > 1e-6) return false;
        }
      }

      // Revisar columnas
      for (let c = 0; c < C; c++) {
        const col = [];
        for (let r = 0; r < R; r++) col.push(grid[r][c]);
        if (col.includes("=")) {
          if (R < 5) return false;
          const num1 = col[0], op = col[1], num2 = col[2], eq = col[3], res = col[4];
          if (num1 === null || op === null || num2 === null || res === null || eq !== "=") return false;
          if (typeof op !== "string") return false;
          const ev = evaluarOperacion(Number(num1), op, Number(num2));
          if (!ev.ok) return false;
          if (Math.abs(ev.calc - Number(res)) > 1e-6) return false;
        }
      }

      return true;
    }

    // Acción cuando el usuario revisa su solución
    function revisarRespuesta() {
      const feedbackEl = document.getElementById("feedback");
      feedbackEl.textContent = "";
      feedbackEl.className = "status";
      const ok = verificarTodasEcuaciones();
      if (ok) {
        puntuacion++;
        feedbackEl.textContent = "¡Crucigrama resuelto! ¡Excelente!";
        feedbackEl.classList.add("correct");
        guardarProgreso();
        // avanzar a siguiente puzzle tras pequeño delay
        setTimeout(() => {
          iniciarJuego(dificultadActual);
        }, 1400);
      } else {
        feedbackEl.textContent = "Algunas operaciones son incorrectas o faltan valores. Revisa las celdas.";
        feedbackEl.classList.add("incorrect");
      }
    }

    // Iniciar juego en una dificultad
    function iniciarJuego(dificultad) {
      dificultadActual = dificultad;
      const puzzle = getRandomPuzzle(dificultad);
      if (!puzzle) {
        alert("No hay puzzles disponibles para esta dificultad.");
        return;
      }
      renderPuzzle(puzzle);
      document.getElementById("feedback").textContent = "";
      showScreen("pantalla-juego");
      // Mostrar anuncio para usuarios no premium
      if (!esPremium) {
        setTimeout(() => {
          mostrarAnuncio();
        }, 5000);
      }
    }

    /************************************************************************
     * GUARDADO / SINCRONIZACIÓN
     ************************************************************************/
    function guardarProgreso() {
      if (!usuarioActual) return;
      const key = "user:" + usuarioActual;
      const localUser = JSON.parse(localStorage.getItem(key) || "{}");
      const data = {
        password: localUser.password || localUser.password,
        isPremium: esPremium,
        score: puntuacion,
        puzzlesSolved: puzzlesResueltosSesion
      };
      localStorage.setItem(key, JSON.stringify(data));
      // Guardar en Firestore (merge)
      setDoc(doc(db, "usuarios", usuarioActual), data, { merge: true })
        .then(() => console.log("Progreso guardado en Firestore para", usuarioActual))
        .catch(err => console.warn("Error guardando en Firestore:", err.message));
    }

    // Guardar progresos localmente sin Firestore (por si no hay usuario)
    function saveProgressLocal() {
      if (!usuarioActual) return;
      const key = "user:" + usuarioActual;
      const localUser = JSON.parse(localStorage.getItem(key) || "{}");
      const data = {
        password: localUser.password || localUser.password,
        isPremium: esPremium,
        score: puntuacion,
        puzzlesSolved: puzzlesResueltosSesion
      };
      localStorage.setItem(key, JSON.stringify(data));
    }

    // Exportar progreso a JSON descargable
    function exportarProgreso() {
      if (!usuarioActual) return alert("Debes iniciar sesión para exportar tu progreso.");
      const data = localStorage.getItem("user:" + usuarioActual);
      if (!data) return alert("No hay datos para exportar.");
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `crossmath_progress_${usuarioActual}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      alert("Progreso exportado.");
    }

    // Importar progreso desde archivo JSON
    function importarProgreso() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json,application/json";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (!imported) throw new Error("Formato inválido");
            const email = imported.email || prompt("Indica el email para asociar este progreso:");
            if (!email) return alert("Importación cancelada (se requiere email).");
            const userData = {
              password: imported.password || "imported-pass",
              isPremium: imported.isPremium || false,
              score: imported.score || 0,
              puzzlesSolved: imported.puzzlesSolved || { facil: [], medio: [], dificil: [] }
            };
            localStorage.setItem("user:" + email, JSON.stringify(userData));
            // Intento de sincronizar con Firestore
            setDoc(doc(db, "usuarios", email), userData, { merge: true })
              .then(() => alert("Progreso importado y sincronizado."))
              .catch(err => alert("Importado localmente, pero no se pudo sincronizar: " + err.message));
          } catch (err) {
            alert("Error al leer el archivo: " + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    /************************************************************************
     * ANUNCIOS
     ************************************************************************/
    function mostrarAnuncio() {
      const popup = document.getElementById("ad-popup");
      if (!popup) return;
      popup.style.display = "flex";
    }
    function cerrarAnuncio() {
      const popup = document.getElementById("ad-popup");
      if (!popup) return;
      popup.style.display = "none";
    }

    /************************************************************************
     * INICIALIZACIÓN Y EVENTOS
     ************************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Mostrar pantalla de login inicialmente
      showScreen("pantalla-auth");
      crearUsuarioDemoSiNoExiste();

      // Elements
      const authForm = document.getElementById("auth-form");
      const authEmail = document.getElementById("auth-email");
      const authPassword = document.getElementById("auth-password");
      const authStatusMsg = document.getElementById("auth-status-msg");

      // Registro demo o botón crear cuenta
      document.getElementById("register-button").addEventListener("click", () => {
        const email = prompt("Introduce el correo electrónico para la nueva cuenta:");
        if (!email) return;
        const pass = prompt("Introduce una contraseña:");
        if (!pass) return;
        const created = registrarUsuario(email, pass);
        if (created) {
          alert("Cuenta creada. Inicia sesión con tus credenciales.");
        }
      });

      // Login
      authForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const email = authEmail.value.trim();
        const pass = authPassword.value.trim();
        if (!email || !pass) {
          authStatusMsg.textContent = "Rellena email y contraseña.";
          return;
        }
        if (autenticar(email, pass)) {
          authStatusMsg.textContent = "";
          // Cargar progreso desde Firestore (intento no bloqueante)
          loadProgressFromCloud(email).finally(() => {
            document.getElementById("mensaje-bienvenida").textContent = `Bienvenido, ${email}`;
            actualizarEstadoPremiumUI();
            showScreen("pantalla-principal");
          });
        } else {
          authStatusMsg.textContent = "Credenciales incorrectas. Intenta de nuevo.";
        }
      });

      // Botones menú principal
      document.getElementById("play-button").addEventListener("click", () => {
        showScreen("pantalla-seleccion-nivel");
      });
      document.getElementById("settings-button").addEventListener("click", () => {
        actualizarEstadoPremiumUI();
        showScreen("pantalla-ajustes");
      });
      document.getElementById("logout-button").addEventListener("click", () => {
        cerrarSesion();
      });

      // Selección de niveles
      document.querySelectorAll(".level-button").forEach(btn => {
        btn.addEventListener("click", (e) => {
          // Reiniciar la lista de resueltos en sesión si se cambia de nivel (opcional)
          // puzzlesResueltosSesion = { facil: [], medio: [], dificil: [] };
          const diff = e.target.dataset.difficulty;
          iniciarJuego(diff);
        });
      });

      // Revisar respuesta
      document.getElementById("submit-answer").addEventListener("click", revisarRespuesta);

      // Volver a niveles
      document.getElementById("back-to-level-select").addEventListener("click", () => {
        showScreen("pantalla-seleccion-nivel");
      });

      // Anuncio - cerrar
      document.getElementById("skip-ad-button").addEventListener("click", () => {
        cerrarAnuncio();
      });

      // Export / Import
      document.getElementById("export-button").addEventListener("click", exportarProgreso);
      document.getElementById("import-button").addEventListener("click", importarProgreso);

      // Comprar premium (abre Gumroad)
      document.getElementById("buy-premium").addEventListener("click", () => {
        if (!usuarioActual) return alert("Debes iniciar sesión para comprar Premium.");
        // Abrir el enlace real de Gumroad proporcionado
        window.open("https://gumroad.com/anacristinacz/l/rnlle", "_blank");
        alert("Cuando completes la compra, el webhook configurado en tu servidor actualizará tu cuenta en Firestore a Premium.");
      });

      // Exportar progreso también desde pantalla principal si existe el botón
      const playButtons = document.querySelectorAll(".level-button");
      playButtons.forEach(b => b.addEventListener("click", () => { /* placeholder */ }));

      // Inicial UI state
      actualizarEstadoPremiumUI();
      document.getElementById("demo-info").innerHTML = "<strong>Cuenta demo</strong><br>Correo: premium_demo@crossmath.com<br>Contraseña: demo123";
    });

    /************************************************************************
     * FUNCIONES ADICIONALES / DEBUG
     ************************************************************************/
    // Para debugging rápido en consola
    window.__crossmath = {
      puzzles,
      getRandomPuzzle,
      renderPuzzle,
      verificarTodasEcuaciones,
      guardarProgreso,
      importarProgreso,
      exportarProgreso,
      autenticar,
      registrarUsuario
    };
  </script>
</head>
<body>
  <div class="app">
    <div class="container">
      <header>
        <h1>CroossMathWeb</h1>
        <p>Juego de operaciones con sincronización real en Firestore y activación Premium vía webhook.</p>
      </header>

      <!-- PANTALLA: Autenticación -->
      <section id="pantalla-auth" class="screen active">
        <h2>Iniciar Sesión</h2>
        <div id="auth-status-msg" class="status" aria-live="polite"></div>
        <form id="auth-form" autocomplete="on">
          <input id="auth-email" type="email" placeholder="Correo electrónico" required />
          <input id="auth-password" type="password" placeholder="Contraseña" required />
          <div style="display:flex;gap:8px;">
            <button type="submit" class="menu-button">Iniciar Sesión</button>
            <button type="button" id="register-button" class="menu-button secondary">Crear Cuenta</button>
          </div>
        </form>
        <div id="demo-info" style="margin-top:12px;color:#444;"></div>
        <p style="margin-top:8px;font-size:0.9rem;color:#666;">
          Nota: La cuenta demo ya está creada y tiene Premium activado para creadores de contenido.
        </p>
      </section>

      <!-- PANTALLA: Menú principal -->
      <section id="pantalla-principal" class="screen">
        <h2>Menú Principal</h2>
        <p id="mensaje-bienvenida"></p>
        <div style="display:flex;gap:8px;flex-direction:column;">
          <button id="play-button" class="menu-button">Jugar</button>
          <button id="settings-button" class="menu-button">Ajustes</button>
          <button id="logout-button" class="menu-button secondary">Cerrar Sesión</button>
        </div>
      </section>

      <!-- PANTALLA: Selección de nivel -->
      <section id="pantalla-seleccion-nivel" class="screen">
        <h2>Selecciona un Nivel</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="level-button" data-difficulty="facil">Fácil</button>
          <button class="level-button" data-difficulty="medio">Medio</button>
          <button class="level-button" data-difficulty="dificil">Difícil</button>
        </div>
        <div style="margin-top:12px;">
          <button id="back-to-menu" class="menu-button secondary" onclick="showScreen('pantalla-principal')">Volver</button>
        </div>
      </section>

      <!-- PANTALLA: Ajustes -->
      <section id="pantalla-ajustes" class="screen">
        <h2>Ajustes</h2>
        <p id="estado-premium">Estado Premium: Sin Premium</p>
        <div style="display:flex;gap:8px;">
          <button id="buy-premium" class="menu-button">Comprar Premium</button>
          <button id="export-button" class="menu-button">Exportar Progreso</button>
          <button id="import-button" class="menu-button">Importar Progreso</button>
        </div>
        <div style="margin-top:12px;">
          <button id="back-settings" class="menu-button secondary" onclick="showScreen('pantalla-principal')">Volver</button>
        </div>
      </section>

      <!-- PANTALLA: Juego -->
      <section id="pantalla-juego" class="screen">
        <h2 id="titulo-juego">Juego</h2>
        <div id="cuadricula-rompecabezas" style="display:grid;gap:8px;max-width:620px;margin:12px auto;"></div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button id="submit-answer" class="menu-button">Revisar Solución</button>
          <button id="back-to-level-select" class="menu-button secondary" onclick="showScreen('pantalla-seleccion-nivel')">Cambiar Nivel</button>
        </div>
        <p id="feedback" class="status" aria-live="polite" style="margin-top:12px;"></p>
      </section>

      <!-- POPUP: Anuncio -->
      <div id="ad-popup" class="ad-screen" role="dialog" aria-hidden="true">
        <div class="ad-card">
          <h3>Anuncio</h3>
          <p>¡Gracias por tu apoyo! Espacio para anuncio real o mensajes promocionales.</p>
          <div id="real-ad-container" style="margin:12px 0;background:#333;color:#eee;padding:10px;border-radius:6px;">(Espacio para el anuncio)</div>
          <button id="skip-ad-button" class="ad-button">Cerrar</button>
        </div>
      </div>

    </div>
  </div>
</body>
</html>
