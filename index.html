<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CrossMathWeb — Juego Sudoku Matemático (Full)</title>
  <meta name="description" content="CrossMathWeb - Sudoku matemático con Firebase Auth + Firestore, multilenguaje, Gumroad Premium y sincronización real."/>
  <style>
    :root{
      --bg1:#041024; --bg2:#071634; --card:#0b1222; --accent:#10b981; --accent2:#06b6d4; --soft:#9fb4c8; --glass:rgba(255,255,255,0.03); --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#e6eef8}
    #bg-canvas{position:fixed;inset:0;z-index:0;pointer-events:none}
    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;position:relative;z-index:2}
    .shell{width:100%;max-width:1180px;border-radius:var(--radius);padding:18px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 30px 80px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    header h1{margin:0;color:var(--accent);font-size:20px}
    header p{margin:0;color:var(--soft);font-size:13px}
    .main-grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .sidebar{padding:12px;border-radius:10px;background:var(--card);border:1px solid rgba(255,255,255,0.02)}
    .panel{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
    .menu-buttons{display:flex;flex-direction:column;gap:10px}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#022;padding:12px 14px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--soft)}
    .level-list{display:flex;flex-direction:column;gap:8px}
    .level-card{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .lvl-facil{border-left:6px solid #60a5fa}
    .lvl-medio{border-left:6px solid #f59e0b}
    .lvl-dificil{border-left:6px solid #ef4444}
    .lvl-infinito{border-left:6px solid #7c3aed}
    .game-area{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);min-height:560px}
    #grid{display:grid;gap:8px;justify-content:center;align-items:center;margin-top:12px}
    .cell{display:flex;align-items:center;justify-content:center;border-radius:8px;padding:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-weight:800;min-width:48px;min-height:48px}
    .cell.op{background:linear-gradient(180deg,rgba(6,182,212,0.06),transparent);color:var(--accent2)}
    .cell.eq{background:linear-gradient(180deg,rgba(255,209,102,0.06),transparent);color:#ffd166}
    .input-cell{width:100%;height:100%;border:none;background:transparent;color:#e6eef8;text-align:center;font-weight:900;outline:none}
    .controls-row{display:flex;gap:8px;align-items:center;margin-top:12px}
    .bottom-area{display:flex;gap:8px;align-items:center;margin-top:12px}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.5);z-index:40}
    #app-toast{position:fixed;right:18px;bottom:18px;padding:10px 14px;border-radius:8px;background:rgba(2,6,23,0.86);color:#fff;z-index:9999;opacity:0;transition:opacity .2s}
    @media(max-width:980px){.main-grid{grid-template-columns:1fr}}
    /* confetti keyframes */
    @keyframes conf-fall{to{transform:translateY(90vh) rotate(720deg);opacity:0}}
  </style>
</head>
<body>
<canvas id="bg-canvas" aria-hidden="true"></canvas>

<div class="app">
  <div class="shell">
    <header>
      <h1 id="app-title">CrossMathWeb</h1>
      <p id="app-sub">Sudoku matemático · Auth · Sync · Premium</p>
    </header>

    <div class="main-grid">
      <aside class="sidebar">
        <div class="panel menu-buttons">
          <button id="btn-play" class="btn large">Jugar</button>
          <button id="btn-levels" class="btn ghost">Niveles</button>
          <button id="btn-profile" class="btn ghost">Perfil</button>
          <button id="btn-settings" class="btn ghost">Ajustes</button>
          <button id="btn-help" class="btn ghost">Ayuda</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.02)">

        <div class="panel">
          <strong id="lbl-user">Invitado</strong>
          <div id="profile-email">—</div>
          <div id="profile-score">0 pts</div>
          <div style="margin-top:8px"><button id="btn-buy" class="btn">Comprar Premium</button></div>
        </div>

        <div style="margin-top:10px" class="panel">
          <label style="display:flex;justify-content:space-between;gap:8px;align-items:center"><span>Idioma</span>
            <select id="langSelect" style="background:transparent;border:none;color:#fff">
              <option value="es">Español</option>
              <option value="en">English</option>
            </select>
          </label>
        </div>

        <div style="margin-top:10px" class="panel">
          <strong>Anuncios</strong>
          <div id="ad-placeholder" style="margin-top:8px;padding:8px;background:linear-gradient(90deg,#0002,#0001);border-radius:8px;color:var(--soft);text-align:center">Banner Ad Placeholder (oculto si premium)</div>
        </div>
      </aside>

      <main class="game-area">
        <div id="screen-menu" class="panel">
          <h2 id="txt-welcome">Bienvenido a CrossMathWeb</h2>
          <p id="txt-sub">Resuelve cuadrículas matemáticas y sube de nivel. Usa menú o selecciona Niveles.</p>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btn-quick-play" class="btn">Jugar ahora</button>
            <button id="btn-open-levels" class="btn ghost">Ver Niveles</button>
          </div>
        </div>

        <div id="screen-levels" class="panel" style="display:none">
          <h3>Selecciona un nivel</h3>
          <div class="level-list">
            <div class="level-card lvl-facil" data-level="facil"><div>Fácil</div><div style="color:var(--soft);font-size:13px">4×4 • Suma / Resta</div></div>
            <div class="level-card lvl-medio" data-level="medio"><div>Medio</div><div style="color:var(--soft);font-size:13px">5×5 • × ÷ • más vacíos</div></div>
            <div class="level-card lvl-dificil" data-level="dificil"><div>Difícil</div><div style="color:var(--soft);font-size:13px">5×5 • Operaciones encadenadas</div></div>
            <div class="level-card lvl-infinito" data-level="infinito"><div>Infinito ♾️</div><div style="color:var(--soft);font-size:13px">Generador procedural</div></div>
          </div>
          <div style="display:flex;justify-content:center;margin-top:12px">
            <button id="back-from-levels" class="btn ghost">Volver</button>
          </div>
        </div>

        <div id="screen-game" class="panel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong id="game-title">Nivel: —</strong>
              <div id="game-sub" style="color:var(--soft);font-size:13px">Instrucciones rápidas</div>
            </div>
            <div>
              <button id="btn-new" class="btn ghost">Nuevo</button>
              <button id="btn-check" class="btn">Revisar</button>
            </div>
          </div>

          <div id="grid" role="grid" aria-label="Cuadrícula"></div>

          <div class="bottom-area">
            <div id="message" style="color:var(--soft)"></div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button id="btn-export" class="btn ghost">Exportar</button>
              <button id="btn-import" class="btn ghost">Importar</button>
            </div>
          </div>

        </div>

      </main>
    </div>

    <div id="app-toast" aria-hidden="true"></div>
  </div>
</div>

<!-- MODALS -->
<div id="modal-login" class="modal" style="display:none">
  <div class="panel" style="width:420px">
    <h3>Iniciar sesión / Crear cuenta</h3>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <input id="auth-email" placeholder="Correo" style="padding:10px;border-radius:8px;border:1px solid #0006;background:transparent;color:#fff" />
      <input id="auth-pass" type="password" placeholder="Contraseña" style="padding:10px;border-radius:8px;border:1px solid #0006;background:transparent;color:#fff"/>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="auth-create" class="btn">Crear</button>
        <button id="auth-login" class="btn ghost">Entrar</button>
        <button id="auth-close" class="btn ghost">Cerrar</button>
      </div>
      <div style="color:var(--soft);font-size:13px;margin-top:6px">Demo: premium_demo@crossmath.com / demo123</div>
    </div>
  </div>
</div>

<!-- SCRIPT: Cliente (Firebase modular v9) -->
<script type="module">
/* ============================
   CrossMathWeb - Cliente único
   Incluye: UI, Grid, Multilengua,
   Firebase Auth & Firestore sync,
   Export/Import, Confetti, Partículas,
   Gumroad buy link (webhook server needed to auto-activate Premium)
   ============================ */

// ---------- Imports Firebase (modular v9) ----------
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

// ---------- Config Firebase (usa tu proyecto ya activo) ----------
const firebaseConfig = {
  apiKey: "AIzaSyCKIUkOfSMOLIhuYcQ30rm1Uc6hg8MFJ04",
  authDomain: "crossmath-sync-db.firebaseapp.com",
  projectId: "crossmath-sync-db",
  storageBucket: "crossmath-sync-db.firebasestorage.app",
  messagingSenderId: "170459630175",
  appId: "1:170459630175:web:6a2a4ccba5dad1fa0ee9ea",
  measurementId: "G-BBJKKN96SV"
};
const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);

// ---------- Estado global ----------
let currentUser = null;
let isPremium = false;
let score = 0;
let currentLevel = 'facil';
let puzzleInMemory = null; // grid object
let lang = (navigator.language && navigator.language.startsWith('en')) ? 'en' : 'es';

// ---------- Multi-language strings ----------
const strings = {
  es: { welcome: 'Bienvenido a CrossMathWeb', play:'Jugar', levels:'Niveles', profile:'Perfil', settings:'Ajustes', help:'Ayuda', signIn:'Iniciar sesión', create:'Crear cuenta', buy:'Comprar Premium', correct:'¡Correcto!', wrong:'Hay errores' },
  en: { welcome:'Welcome to CrossMathWeb', play:'Play', levels:'Levels', profile:'Profile', settings:'Settings', help:'Help', signIn:'Sign In', create:'Create', buy:'Buy Premium', correct:'Correct!', wrong:'There are errors' }
};
function t(k){ return (strings[lang] && strings[lang][k]) ? strings[lang][k] : k; }

// ---------- Helpers ----------
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function showToast(msg, dur=1800){ const el = $('#app-toast'); if (!el) return; el.textContent = msg; el.style.opacity = '1'; setTimeout(()=> el.style.opacity = '0', dur); }

// ---------- UI Bindings (robustos) ----------
function showScreen(name){
  const id = name.startsWith('screen-') ? name : 'screen-' + name;
  ['screen-menu','screen-levels','screen-game'].forEach(s => {
    const el = document.getElementById(s);
    if (!el) return;
    el.style.display = (s === id) ? 'block' : 'none';
  });
}
const btnPlay = $('#btn-play'); if (btnPlay) btnPlay.addEventListener('click', ()=>{ showScreen('game'); loadOrGenerate(); });
const btnLevels = $('#btn-levels'); if (btnLevels) btnLevels.addEventListener('click', ()=> showScreen('levels'));
const btnProfile = $('#btn-profile'); if (btnProfile) btnProfile.addEventListener('click', ()=> $('#modal-login').style.display='flex');
const btnHelp = $('#btn-help'); if (btnHelp) btnHelp.addEventListener('click', ()=> alert(t('help') + ': Completa las celdas vacías con números que hagan válidas las operaciones.'));
const btnSettings = $('#btn-settings'); if (btnSettings) btnSettings.addEventListener('click', ()=> alert(t('settings') + ': Sonido y progreso.'));
const btnBuy = $('#btn-buy'); if (btnBuy) btnBuy.addEventListener('click', ()=> { window.open('https://gumroad.com/anacristinacz/l/rnlle','_blank'); showToast('Abriendo Gumroad...'); });

$('#btn-quick-play')?.addEventListener('click', ()=>{ showScreen('game'); loadOrGenerate(); });
$('#btn-open-levels')?.addEventListener('click', ()=> showScreen('levels'));
$('#back-from-levels')?.addEventListener('click', ()=> showScreen('menu'));
$('#back-to-menu')?.addEventListener('click', ()=> showScreen('menu'));

$('#btn-new')?.addEventListener('click', ()=>{ puzzleInMemory = generateGrid(currentLevel); renderGrid(puzzleInMemory); $('#message').textContent = ''; });
$('#btn-check')?.addEventListener('click', ()=> { const ok = validateCurrentGrid(); if (ok) { showToast(t('correct')); burstConfetti(); score += 10; saveProgressToCloud(); updateProfileUI(); puzzleInMemory = generateGrid(currentLevel); renderGrid(puzzleInMemory); } else { showToast(t('wrong')); }});

// level card clicks
$$('.level-card').forEach(card => card.addEventListener('click', ()=>{ const lvl = card.dataset.level || 'facil'; currentLevel = lvl; $('#game-title').textContent = 'Nivel: ' + lvl; showScreen('game'); loadOrGenerate(); showToast('Nivel: '+lvl); }));

// export / import
$('#btn-export')?.addEventListener('click', ()=> {
  const payload = { email: currentUser ? currentUser.email : 'demo', isPremium, score, lastPuzzle: puzzleInMemory || null, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'crossmath_progress.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast('Exportado');
});
$('#btn-import')?.addEventListener('click', ()=> {
  const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = async (e) => {
    const file = e.target.files[0]; if (!file) return;
    const text = await file.text(); try { const parsed = JSON.parse(text); if (parsed.lastPuzzle) { puzzleInMemory = parsed.lastPuzzle; renderGrid(puzzleInMemory); showToast('Progreso importado'); } } catch(err){ alert('Archivo inválido'); }
  }; input.click();
});

// language selection
$('#langSelect')?.addEventListener('change', e => { lang = e.target.value; applyLanguage(); });
function applyLanguage(){ $('#txt-welcome').textContent = t('welcome'); $('#btn-play').textContent = t('play'); $('#btn-levels').textContent = t('levels'); $('#btn-profile').textContent = t('profile'); $('#btn-settings').textContent = t('settings'); $('#btn-help').textContent = t('help'); $('#btn-buy').textContent = t('buy'); }
applyLanguage();

// ---------- Auth: create / login ----------
$('#auth-create')?.addEventListener('click', async ()=>{
  const email = $('#auth-email').value.trim(); const pass = $('#auth-pass').value.trim();
  if (!email || !pass) { alert('Email y contraseña'); return; }
  try { const cred = await createUserWithEmailAndPassword(auth, email, pass); currentUser = cred.user; onUserSignedIn(currentUser); $('#modal-login').style.display='none'; showToast('Cuenta creada'); } catch(err){ console.error(err); alert(err.message || err); }
});
$('#auth-login')?.addEventListener('click', async ()=>{
  const email = $('#auth-email').value.trim(); const pass = $('#auth-pass').value.trim();
  if (!email || !pass) { alert('Email y contraseña'); return; }
  try { const cred = await signInWithEmailAndPassword(auth, email, pass); currentUser = cred.user; onUserSignedIn(currentUser); $('#modal-login').style.display='none'; showToast('Sesión iniciada'); } catch(err){ console.error(err); alert(err.message || err); }
});
$('#auth-close')?.addEventListener('click', ()=> $('#modal-login').style.display='none');

// onAuth state
onAuthStateChanged(auth, user => {
  if (user) { currentUser = user; onUserSignedIn(user); } else { currentUser = null; updateProfileUI(); }
});

function onUserSignedIn(user){
  $('#lbl-user').textContent = user.email; $('#profile-email').textContent = user.email;
  // attach doc listener to users/<email>
  attachUserDocListener(user.email);
}

// ---------- Firestore: attach listener, save/load ----------
let unsubscribeUserDoc = null;
async function attachUserDocListener(email){
  try {
    if (unsubscribeUserDoc) unsubscribeUserDoc();
    const ref = doc(db, 'users', email);
    unsubscribeUserDoc = onSnapshot(ref, snap => {
      if (!snap.exists()) return;
      const d = snap.data();
      isPremium = !!d.isPremium;
      score = d.score || 0;
      $('#profile-score').textContent = (score||0) + ' pts';
      $('#lbl-user').textContent = email;
      // hide ads if premium
      if (isPremium) $('#ad-placeholder').style.display = 'none';
      else $('#ad-placeholder').style.display = 'block';
      showToast('Sincronizado');
    }, err => console.warn('onSnapshot err', err));
  } catch(e) { console.warn('attach err', e); }
}

async function saveProgressToCloud(){
  if (!currentUser) return;
  try {
    const payload = { email: currentUser.email, isPremium, score, lastPuzzle: puzzleInMemory || null, updatedAt: Date.now() };
    await setDoc(doc(db, 'users', currentUser.email), payload, { merge: true });
    showToast('Guardado en la nube');
  } catch(e){ console.warn('save err', e); showToast('Error guardando'); }
}

async function loadProgressFromCloud(email){
  try {
    const snap = await getDoc(doc(db, 'users', email));
    return snap.exists() ? snap.data() : null;
  } catch(e){ console.warn('load err', e); return null; }
}

// ---------- Demo user setup in localStorage (convenience) ----------
(function createDemo(){
  const demoKey = 'user:premium_demo@crossmath.com';
  if (!localStorage.getItem(demoKey)) {
    const demo = { password:'demo123', isPremium:true, score:0, createdAt: Date.now() };
    localStorage.setItem(demoKey, JSON.stringify(demo));
    // Also ensure demo exists in Firestore if possible (best-effort)
    try { setDoc(doc(db, 'users', 'premium_demo@crossmath.com'), {...demo, email:'premium_demo@crossmath.com'}, { merge:true }); } catch(e) { /* ignore */ }
  }
})();

// ---------- Grid generation: 4x4 (fácil) y 5x5 (medio/difícil) ----------
// Internal representation: rows = 2*N -1, cols = 2*N (numbers and ops, '=' and result)
function generateGrid(level){
  const N = (level === 'facil') ? 4 : 5;
  const rows = 2*N - 1;
  const cols = 2*N;
  const grid = Array.from({length:rows}, ()=> Array(cols).fill(''));
  // Fill rows (even rows 0,2,4...) with expressions
  for (let r = 0; r < rows; r += 2){
    const nums = []; const ops = [];
    for (let i=0;i<N;i++){
      nums.push(Math.floor(Math.random()*(level==='facil'?8:12))+1);
      if (i < N-1) {
        const choice = (level==='facil') ? ['+','-'][Math.floor(Math.random()*2)] : ['+','-','*','/'][Math.floor(Math.random()*4)];
        ops.push(choice);
      }
    }
    // Evaluate left-to-right with no precedence (simple)
    let val = Number(nums[0]);
    for (let i=0;i<ops.length;i++){
      const b = Number(nums[i+1]);
      const op = ops[i];
      if (op === '+') val += b;
      else if (op === '-') val -= b;
      else if (op === '*') val *= b;
      else if (op === '/') { if (b !== 0 && val % b === 0) val = Math.floor(val / b); else val = Math.floor(val / (b || 1)); }
    }
    // write row tokens
    let c = 0;
    for (let i=0;i<nums.length;i++){
      grid[r][c] = nums[i]; c++;
      if (i < ops.length){ grid[r][c] = ops[i]; c++; }
    }
    grid[r][c] = '='; grid[r][c+1] = val;
  }
  // Fill some column numbers to allow vertical validation sometimes
  for (let c = 0; c < cols; c += 2){
    const nums = []; const ops = [];
    for (let i=0;i<N;i++){ nums.push(Math.floor(Math.random()*(level==='facil'?8:12))+1); if (i<N-1) ops.push((level==='facil') ? ['+','-'][Math.floor(Math.random()*2)] : ['+','-','*','/'][Math.floor(Math.random()*4)]); }
    let r=0;
    for (let i=0;i<nums.length;i++){ grid[r][c] = nums[i]; r += 2; }
    // put a result near bottom to sometimes match vertical evaluation
    if (rows > 0) { grid[rows-1][c+1] = '='; grid[rows-1][Math.min(c+2, cols-1)] = nums.reduce((a,b)=>a+b,0); }
  }
  return { id: 'p-'+Date.now(), grid };
}

// ---------- Render grid to DOM ----------
function renderGrid(obj){
  puzzleInMemory = obj;
  const gridEl = $('#grid');
  gridEl.innerHTML = '';
  const g = obj.grid;
  const rows = g.length;
  const cols = g[0].length;
  // set CSS columns (64px per col)
  gridEl.style.gridTemplateColumns = `repeat(${cols}, 64px)`;
  for (let r = 0; r < rows; r++){
    for (let c = 0; c < cols; c++){
      const v = g[r][c];
      const div = document.createElement('div'); div.className = 'cell';
      if (v === '' || v === null || typeof v === 'undefined'){
        if (r % 2 === 0 && c % 2 === 0){
          const inp = document.createElement('input'); inp.className = 'input-cell'; inp.type = 'number'; inp.dataset.r = r; inp.dataset.c = c;
          div.appendChild(inp);
        } else { div.textContent = ''; }
      } else {
        if (['+','-','*','/'].includes(String(v))){ div.classList.add('op'); div.textContent = v; }
        else if (String(v) === '='){ div.classList.add('eq'); div.textContent = '='; }
        else { div.textContent = v; }
      }
      gridEl.appendChild(div);
    }
  }
}

// ---------- Validate puzzle (rows and attempt some column checks) ----------
function evalOp(a,op,b){
  a = Number(a); b = Number(b);
  if (isNaN(a) || isNaN(b)) return null;
  if (op === '+') return a + b;
  if (op === '-') return a - b;
  if (op === '*') return a * b;
  if (op === '/') return (b !== 0 && a % b === 0) ? a / b : null;
  return null;
}

function validateCurrentGrid(){
  if (!puzzleInMemory) return false;
  const grid = puzzleInMemory.grid;
  // gather inputs
  $$('.input-cell').forEach(inp => {
    const r = Number(inp.dataset.r); const c = Number(inp.dataset.c); const val = inp.value.trim();
    grid[r][c] = (val === '') ? '' : Number(val);
  });
  const rows = grid.length; const cols = grid[0].length;
  // validate rows (even rows)
  for (let r = 0; r < rows; r += 2){
    const row = grid[r];
    const eqIdx = row.indexOf('=');
    if (eqIdx !== -1){
      const tokens = row.slice(0, eqIdx).filter(x => x !== '' && x !== null && typeof x !== 'undefined');
      if (tokens.length === 0) return false;
      let val = Number(tokens[0]);
      for (let i = 1; i < tokens.length; i += 2){
        const op = tokens[i]; const b = Number(tokens[i+1]);
        const res = evalOp(val, op, b);
        if (res === null) return false;
        val = res;
      }
      const expected = Number(row[eqIdx+1]);
      if (val !== expected) return false;
    }
  }
  // rudimentary column checks (if all numbers present)
  for (let c = 0; c < cols; c += 2){
    const nums = []; const ops = [];
    for (let r = 0; r < rows; r += 2){
      const v = grid[r][c];
      if (v === '' || v === null || typeof v === 'undefined'){ nums.push(null); } else nums.push(Number(v));
      if (r+1 < rows){ const op = grid[r+1][c]; if (op) ops.push(op); }
    }
    if (!nums.includes(null) && nums.length >= 2){
      let val = nums[0]; let ok = true;
      for (let i=0;i<ops.length;i++){ const res = evalOp(val, ops[i], nums[i+1]); if (res === null){ ok = false; break; } val = res; }
      if (!ok) return false;
      const possibleRes = grid[rows-1][c+1];
      if (possibleRes !== '' && possibleRes !== undefined && Number(possibleRes) !== val) return false;
    }
  }
  return true;
}

// ---------- Effects: confetti ----------
function burstConfetti(){
  const wrap = document.createElement('div'); wrap.style.position='fixed'; wrap.style.inset='0'; wrap.style.pointerEvents='none'; wrap.style.zIndex=9999;
  for (let i=0;i<40;i++){
    const p = document.createElement('div'); p.style.position='absolute'; p.style.left = Math.random()*100 + '%'; p.style.top = Math.random()*20 + '%'; p.style.width='10px'; p.style.height='14px';
    p.style.background = ['#06b6d4','#10b981','#f59e0b','#ef4444','#7c3aed'][Math.floor(Math.random()*5)];
    p.style.transform = 'translateY(-10vh) rotate('+Math.random()*360+'deg)'; p.style.animation = 'conf-fall '+(800+Math.random()*900)+'ms linear forwards'; wrap.appendChild(p);
  }
  document.body.appendChild(wrap); setTimeout(()=> wrap.remove(), 1600);
}

// ---------- Background particles (canvas) ----------
function startBgParticles(){
  const canvas = document.getElementById('bg-canvas'); const ctx = canvas.getContext('2d');
  let w = canvas.width = innerWidth; let h = canvas.height = innerHeight;
  const parts = [];
  function rand(a,b){ return Math.random()*(b-a)+a; }
  for (let i=0;i<120;i++) parts.push({ x: rand(0,w), y: rand(0,h), r: rand(0.6,3), vx: rand(-0.2,0.6), vy: rand(-0.1,0.3), hue: rand(180,260) });
  window.addEventListener('resize', ()=>{ w = canvas.width = innerWidth; h = canvas.height = innerHeight; });
  (function loop(){
    ctx.clearRect(0,0,w,h);
    const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'rgba(6,182,212,0.04)'); g.addColorStop(1,'rgba(124,58,237,0.03)'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
    parts.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x > w+20) p.x = -20; if (p.y > h+20) p.y = -20; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fillStyle = `hsla(${p.hue},85%,65%,0.12)`; ctx.fill(); });
    requestAnimationFrame(loop);
  })();
}

// ---------- Load or generate puzzle (and attempt to load from cloud if user logged) ----------
async function loadOrGenerate(){
  if (currentUser){
    const data = await loadProgressFromCloud(currentUser.email);
    if (data && data.lastPuzzle) { puzzleInMemory = data.lastPuzzle; renderGrid(puzzleInMemory); return; }
  }
  puzzleInMemory = generateGrid(currentLevel);
  renderGrid(puzzleInMemory);
}

// ---------- Save/load helpers (cloud) ----------
async function saveProgressToCloud(){
  if (!currentUser) { showToast('Inicia sesión para sincronizar'); return; }
  try {
    const payload = { email: currentUser.email, isPremium, score, lastPuzzle: puzzleInMemory || null, updatedAt: Date.now() };
    await setDoc(doc(db, 'users', currentUser.email), payload, { merge: true });
    showToast('Guardado en la nube');
  } catch(e){ console.warn(e); showToast('Error guardando'); }
}
async function loadProgressFromCloud(email){ try { const snap = await getDoc(doc(db, 'users', email)); return snap.exists() ? snap.data() : null; } catch(e){ console.warn(e); return null; } }

// ---------- Attach realtime listener to user's doc (called on login) ----------
let unsubscribeUser = null;
async function attachUserDocListener(email){
  if (unsubscribeUser) unsubscribeUser();
  try {
    unsubscribeUser = onSnapshot(doc(db, 'users', email), snap => {
      if (!snap.exists()) return;
      const d = snap.data();
      isPremium = !!d.isPremium; score = d.score || 0;
      $('#profile-score').textContent = (score||0) + ' pts';
      $('#lbl-user').textContent = email;
      if (isPremium) $('#ad-placeholder').style.display = 'none'; else $('#ad-placeholder').style.display = 'block';
      showToast('Sincronizado');
    }, err => console.warn('snap err', err));
  } catch(e){ console.warn('attach err', e); }
}

// ---------- Update profile UI ----------
function updateProfileUI(){
  $('#lbl-user').textContent = currentUser ? currentUser.email : 'Invitado';
  $('#profile-email').textContent = currentUser ? currentUser.email : '—';
  $('#profile-score').textContent = (score||0) + ' pts';
}

// ---------- Keyboard shortcuts ----------
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') $('#btn-check')?.click();
  if (e.key.toLowerCase() === 'n' && document.activeElement?.tagName !== 'INPUT') $('#btn-new')?.click();
});

// ---------- Initialization ----------
startBgParticles();
showScreen('menu');
applyLanguage();
updateProfileUI();

// ensure demo UI hints
$('#txt-welcome').textContent = t('welcome') + ' • Demo disponible';

// ---------- Notes about Premium activation ----------
/*
  To fully enable automatic Premium activation:
  - Deploy a server/webhook (Cloud Function or other) endpoint that Gumroad will call on purchase.
  - The webhook should write { isPremium: true } to users/<buyerEmail> in Firestore.
  - Client listens with onSnapshot and will update UI immediately.
*/

// ---------- End of module ----------
</script>

</body>
</html>
