<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CrossMathWeb - Correcciones</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f1724; --accent:#ffd166; --muted:#9aa4b2;
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,#061125 0%, #0b1020 100%); color:#e6eef6;}
  #particles{position:fixed;inset:0;z-index:0;pointer-events:none}
  .app{position:relative;z-index:1;max-width:1100px;margin:28px auto;padding:22px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:18px;box-shadow:0 6px 30px rgba(2,6,23,0.6);}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  h1{margin:0;font-size:20px;letter-spacing:0.6px}
  .nav{display:flex;gap:8px}
  .btn{background:var(--accent);color:#08121a;padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(255,209,102,0.12);transition:transform .12s ease,box-shadow .12s;}
  .btn:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(255,209,102,0.14)}
  .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,209,102,0.12)}
  .small{padding:6px 9px;font-size:13px;border-radius:8px}
  nav.main-buttons{display:flex;gap:10px;justify-content:center;margin:26px 0}
  .levels{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .level-card{width:180px;height:120px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#071018;cursor:pointer;box-shadow:0 8px 30px rgba(2,6,23,0.5);transition:transform .12s}
  .level-card:hover{transform:translateY(-6px)}
  .level-easy{background:linear-gradient(90deg,#fff3bf,#ffd166)}
  .level-med{background:linear-gradient(90deg,#bde0fe,#74c0fc)}
  .level-hard{background:linear-gradient(90deg,#f8d7da,#f28b82)}
  .level-inf{background:linear-gradient(90deg,#d3f9d8,#99f6b3)}
  .grid-wrap{display:flex;gap:16px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
  .grid{background:#fff7e6;border-radius:12px;padding:12px;display:grid;grid-template-columns:repeat(5,54px);grid-auto-rows:54px;gap:8px}
  .cell{background:#ffefc1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2a2a2a;user-select:none}
  .cell.fixed{background:#ffeaa7;opacity:0.95}
  .pad{display:grid;grid-template-columns:repeat(1,1fr);gap:8px}
  .num-btn{background:#1b7a4b;color:white;padding:10px;border-radius:10px;border:none;cursor:pointer}
  .hud{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:12px}
  .muted{color:var(--muted);font-size:13px}
  .confetti{position:fixed;pointer-events:none;z-index:50;inset:0}
  footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
  .hidden{display:none}
  .settings-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
  select.lang{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:6px;border-radius:6px}
  .profile-card{display:flex;gap:14px;align-items:center}
  .badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.04);font-weight:600}
  .timer{font-family:monospace;background:rgba(0,0,0,0.06);padding:6px 8px;border-radius:8px}
  .toast{position:fixed;right:20px;bottom:20px;background:#0d2633;padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.6);color:#dff3f6}
  @media (max-width:900px){
    .grid{grid-template-columns:repeat(4,54px)}
  }
</style>
</head>
<body>
<canvas id="particles"></canvas>
<div class="app card" id="app">
  <header>
    <h1>CrossMathWeb</h1>
    <div class="profile-card">
      <div id="userEmail" class="muted">No conectado</div>
      <div id="premiumBadge" class="badge" style="display:none;background:linear-gradient(90deg,#ffd166,#f08a5d);color:#071018">Premium</div>
      <button id="btnSign" class="btn small">Entrar</button>
    </div>
  </header>

  <main id="mainView">
    <section id="menu" class="center">
      <div class="nav main-buttons">
        <button class="btn" id="playBtn">Jugar</button>
        <button class="btn secondary" id="levelsBtn">Niveles</button>
        <button class="btn secondary" id="profileBtn">Perfil</button>
        <button class="btn secondary" id="settingsBtn">Ajustes</button>
        <button class="btn secondary" id="helpBtn">Ayuda</button>
      </div>
      <div style="text-align:center;color:var(--muted);margin-top:6px" id="demoCred">Demo: premium_demo@crossmath.com / demo123</div>
    </section>

    <section id="levels" class="hidden card" style="margin-top:12px">
      <h3>Selección de niveles</h3>
      <div class="levels" id="levelsList" style="margin-top:12px">
        <div class="level-card level-easy" data-level="easy"><strong>Fácil</strong><div class="muted">5x5 · operadores + -</div></div>
        <div class="level-card level-med" data-level="medium"><strong>Medio</strong><div class="muted">5x5 · + - ×</div></div>
        <div class="level-card level-hard" data-level="hard"><strong>Difícil</strong><div class="muted">6x6 · + - × ÷</div></div>
        <div class="level-card level-inf" data-level="infinite"><strong>Infinito</strong><div class="muted">Generación continua</div></div>
      </div>
    </section>

    <section id="game" class="hidden card" style="margin-top:12px;text-align:center">
      <div class="hud">
        <div class="timer" id="timer">00:00</div>
        <div class="muted" id="levelLabel">Nivel</div>
        <div class="muted" id="scoreLabel">Puntos: 0</div>
      </div>
      <div class="grid-wrap" id="gridWrap">
        <div id="grid" class="grid" aria-hidden="false"></div>
        <div class="pad" id="pad"></div>
      </div>
      <div style="margin-top:12px">
        <button id="validateBtn" class="btn">Validar</button>
        <button id="saveBtn" class="btn secondary">Guardar progreso</button>
        <button id="exportBtn" class="btn secondary">Exportar JSON</button>
        <button id="backToMenu" class="btn small secondary">Volver</button>
      </div>
    </section>

    <section id="profile" class="hidden card" style="margin-top:12px">
      <h3>Perfil</h3>
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div>
          <div id="profileEmail" class="muted">-</div>
          <div id="profileStatus" class="muted">Estado: -</div>
        </div>
        <div style="text-align:right">
          <button id="buyPremium" class="btn">Comprar Premium</button>
          <div style="margin-top:8px">
            <button id="logoutBtn" class="btn secondary small">Cerrar sesión</button>
          </div>
        </div>
      </div>
    </section>

    <section id="settings" class="hidden card" style="margin-top:12px">
      <h3>Ajustes</h3>
      <div class="settings-row">
        <label class="muted">Idioma</label>
        <select id="selectLang" class="lang">
          <option value="es">Español</option>
          <option value="en">English</option>
        </select>
        <button id="ensureDemo" class="btn small secondary">Iniciar demo</button>
      </div>
    </section>

    <section id="help" class="hidden card" style="margin-top:12px">
      <h3>Ayuda</h3>
      <div class="muted">Completa la cuadrícula tipo sudoku matemático; celdas fijas y vacías; operadores entre celdas y validación automática; Premium desbloquea niveles y quita anuncios.</div>
    </section>

  </main>

  <footer>
    <div class="muted">CrossMathWeb · Implementación conectada con Firebase (crossmath-sync-db) y Gumroad (rnlle)</div>
  </footer>
</div>

<canvas id="confetti" class="confetti"></canvas>
<div id="toast" class="toast hidden"></div>

<script type="module">
/* ========= FIREBASE v9 modular - REEMPLAZA con credenciales del proyecto crossmath-sync-db ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "REEMPLAZA_API_KEY",
  authDomain: "crossmath-sync-db.firebaseapp.com",
  projectId: "crossmath-sync-db",
  storageBucket: "crossmath-sync-db.appspot.com",
  messagingSenderId: "REEMPLAZA_MESSAGING_SENDER_ID",
  appId: "REEMPLAZA_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========== Traducciones (i18n) ========== */
const translations = {
  es: {
    play: "Jugar", levels: "Niveles", profile: "Perfil", settings: "Ajustes", help: "Ayuda",
    validate: "Validar", save: "Guardar progreso", export: "Exportar JSON",
    demoCred: "Demo: premium_demo@crossmath.com / demo123",
    buying: "Redirigiendo a Gumroad...", saved: "Progreso guardado", loaded: "Progreso cargado", premiumActive: "Premium activo",
    connectToSave: "Conéctate para guardar", selectCell: "Selecciona una celda"
  },
  en: {
    play: "Play", levels: "Levels", profile: "Profile", settings: "Settings", help: "Help",
    validate: "Validate", save: "Save progress", export: "Export JSON",
    demoCred: "Demo: premium_demo@crossmath.com / demo123",
    buying: "Redirecting to Gumroad...", saved: "Progress saved", loaded: "Progress loaded", premiumActive: "Premium active",
    connectToSave: "Sign in to save", selectCell: "Select a cell"
  }
};
let currentLang = navigator.language && navigator.language.startsWith('es') ? 'es' : 'en';
document.getElementById('selectLang').value = currentLang;
function t(k){ return translations[currentLang][k] || k; }
function applyLang(){
  document.getElementById('playBtn').textContent = t('play');
  document.getElementById('levelsBtn').textContent = t('levels');
  document.getElementById('profileBtn').textContent = t('profile');
  document.getElementById('settingsBtn').textContent = t('settings');
  document.getElementById('helpBtn').textContent = t('help');
  document.getElementById('validateBtn').textContent = t('validate');
  document.getElementById('saveBtn').textContent = t('save');
  document.getElementById('exportBtn').textContent = t('export');
  document.getElementById('demoCred').textContent = t('demoCred');
}
applyLang();
document.getElementById('selectLang').addEventListener('change', e => { currentLang = e.target.value; applyLang(); });

/* ========== RUTAS / VISTAS ========== */
const views = ['menu','levels','game','profile','settings','help'];
function show(view){
  views.forEach(v=>document.getElementById(v).classList.add('hidden'));
  document.getElementById(view).classList.remove('hidden');
}
document.getElementById('playBtn').addEventListener('click', ()=> { startLevel('easy'); show('game'); });
document.getElementById('levelsBtn').addEventListener('click', ()=> show('levels'));
document.getElementById('profileBtn').addEventListener('click', ()=> show('profile'));
document.getElementById('settingsBtn').addEventListener('click', ()=> show('settings'));
document.getElementById('helpBtn').addEventListener('click', ()=> show('help'));

/* ========== DEMO ACCOUNT helper (según txt) ========== */
const DEMO = { email: "premium_demo@crossmath.com", pwd: "demo123" };
const btnSign = document.getElementById('btnSign');
const userEmailEl = document.getElementById('userEmail');
const profileEmail = document.getElementById('profileEmail');
const profileStatus = document.getElementById('profileStatus');
const premiumBadge = document.getElementById('premiumBadge');

async function ensureDemoUser(){
  try{
    await signInWithEmailAndPassword(auth, DEMO.email, DEMO.pwd);
  }catch(e){
    if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password'){
      try{
        await createUserWithEmailAndPassword(auth, DEMO.email, DEMO.pwd);
        await signInWithEmailAndPassword(auth, DEMO.email, DEMO.pwd);
      }catch(inner){ console.error(inner); showToast('Error demo user') }
    } else { console.error(e); showToast('Auth error') }
  }
}
document.getElementById('ensureDemo').addEventListener('click', ensureDemoUser);

btnSign.addEventListener('click', async ()=>{
  if(auth.currentUser) { await signOut(auth); return; }
  const email = prompt("Email", DEMO.email);
  const pwd = prompt("Password", DEMO.pwd);
  if(!email || !pwd) return;
  try{
    await signInWithEmailAndPassword(auth, email, pwd);
  }catch(e){
    if(e.code === 'auth/user-not-found'){
      try{ await createUserWithEmailAndPassword(auth, email, pwd); await signInWithEmailAndPassword(auth, email, pwd); }
      catch(er){ console.error(er); showToast('Error creating user'); }
    } else { console.error(e); showToast('Login error'); }
  }
});

/* ========== ON AUTH STATE: ensure Firestore doc + realtime snapshot (saveProgress/loadProgress usage) ========== */
onAuthStateChanged(auth, async user => {
  if(user){
    userEmailEl.textContent = user.email;
    btnSign.textContent = 'Salir';
    profileEmail.textContent = user.email;
    const ref = doc(db,'users',user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, { email: user.email, isPremium: false, score:0, progress:{}, puzzlesUsed:[], lastUpdated: serverTimestamp() });
    }
    onSnapshot(ref, docSnap => {
      if(docSnap.exists()){
        const data = docSnap.data();
        profileStatus.textContent = 'Estado: ' + (data.isPremium ? 'Premium' : 'Gratis');
        premiumBadge.style.display = data.isPremium ? 'inline-block' : 'none';
        if(data.isPremium) showToast(t('premiumActive'));
      }
    });
  } else {
    userEmailEl.textContent = 'No conectado';
    btnSign.textContent = 'Entrar';
    profileEmail.textContent = '-';
    profileStatus.textContent = 'Estado: -';
    premiumBadge.style.display = 'none';
  }
});

/* ========== GUMROAD flow (cliente) - producto rnlle ========== */
const GUMROAD_PRODUCT_URL = "https://gumroad.com/l/rnlle"; // rnlle según txt
document.getElementById('buyPremium').addEventListener('click', async ()=>{
  showToast(t('buying'));
  window.open(GUMROAD_PRODUCT_URL, '_blank');
  // Nota: webhook backend necesario para validar compra y activar isPremium en Firestore (ver instrucciones dentro).
});

/* ========== saveProgress() y loadProgress() conectados al proyecto crossmath-sync-db (según txt) ========== */
async function saveProgress(progressObj){
  const user = auth.currentUser;
  if(!user) return showToast(t('connectToSave'));
  const ref = doc(db, 'users', user.uid);
  await updateDoc(ref, { progress: progressObj, lastUpdated: serverTimestamp(), score: progressObj.score || 0 }, { merge: true });
  showToast(t('saved'));
}

async function loadProgress(){
  const user = auth.currentUser;
  if(!user) return null;
  const ref = doc(db, 'users', user.uid);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const data = snap.data();
    showToast(t('loaded'));
    return data.progress || {};
  }
  return null;
}

/* ========== Exportación crossmath_progress.json (según txt) ========== */
document.getElementById('exportBtn').addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if(!user) return showToast(t('connectToSave'));
  const ref = doc(db, 'users', user.uid);
  const snap = await getDoc(ref);
  const data = snap.exists() ? snap.data() : { email: user.email };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'crossmath_progress.json'; a.click();
  URL.revokeObjectURL(url);
});

/* ========== Motor de puzzles (estructura y validación robusta acorde al txt) ==========
   Requisitos desde el archivo: cuadrícula tipo sudoku matemático, celdas fijas y vacías,
   operadores entre celdas (+ - × ÷), validación automática, manejo de división, evitar división por cero.
   saveProgress() y loadProgress() persisten el estado.
========================================================================== */

let activeLevel = 'easy';
let currentGrid = []; // [{value:number|null, fixed:boolean}]
let operatorSet = ['+','-'];
let gridSize = 5;
let timerInterval = null;
let startTime = null;
let currentScore = 0;

function configureLevel(level){
  activeLevel = level;
  if(level === 'easy'){ gridSize = 5; operatorSet = ['+','-']; }
  else if(level === 'medium'){ gridSize = 5; operatorSet = ['+','-','*']; }
  else if(level === 'hard'){ gridSize = 6; operatorSet = ['+','-','*','/']; }
  else { gridSize = 6; operatorSet = ['+','-','*','/']; }
  document.getElementById('levelLabel').textContent = 'Nivel: ' + level;
}

function generatePuzzle(level){
  configureLevel(level);
  currentGrid = [];
  // Generador simple pero controlado: mezcla fijos y vacíos; garantiza al menos 1 fijo por fila.
  for(let r=0;r<gridSize;r++){
    for(let c=0;c<gridSize;c++){
      if(Math.random() < 0.36){
        currentGrid.push({ value: Math.floor(Math.random()*19)+1, fixed:true });
      } else {
        currentGrid.push({ value: null, fixed:false });
      }
    }
  }
  for(let r=0;r<gridSize;r++){
    const row = currentGrid.slice(r*gridSize, r*gridSize+gridSize);
    if(!row.some(cell=>cell.fixed)){
      const idx = r*gridSize + Math.floor(Math.random()*gridSize);
      currentGrid[idx].value = Math.floor(Math.random()*12)+1;
      currentGrid[idx].fixed = true;
    }
  }
  currentScore = 0;
  renderGrid();
}

function renderGrid(){
  const gridEl = document.getElementById('grid');
  gridEl.style.gridTemplateColumns = `repeat(${gridSize},54px)`;
  gridEl.innerHTML = '';
  currentGrid.forEach((cell, idx)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (cell.fixed ? 'fixed' : 'editable');
    div.dataset.idx = idx;
    div.tabIndex = 0;
    div.textContent = cell.value === null ? '' : cell.value;
    if(!cell.fixed){
      div.addEventListener('click', ()=>{ focusCell(idx); });
    }
    gridEl.appendChild(div);
  });
  renderPad();
  resetTimer();
}

let focusedIdx = null;
function focusCell(idx){
  focusedIdx = idx;
  document.querySelectorAll('.cell').forEach(el=>el.style.outline='none');
  const el = document.querySelector(`.cell[data-idx="${idx}"]`);
  if(el) el.style.outline = '3px solid rgba(2,120,80,0.18)';
}

function renderPad(){
  const pad = document.getElementById('pad');
  pad.innerHTML = '';
  const maxNum = activeLevel === 'infinite' ? 100 : 20;
  for(let n=1;n<=maxNum;n++){
    const b = document.createElement('button');
    b.className = 'num-btn';
    b.textContent = n;
    b.addEventListener('click', ()=>{ onPadPress(n); });
    pad.appendChild(b);
  }
  const clear = document.createElement('button');
  clear.className = 'num-btn';
  clear.textContent = 'Del';
  clear.addEventListener('click', ()=>{ if(focusedIdx!==null && !currentGrid[focusedIdx].fixed) { currentGrid[focusedIdx].value = null; renderGrid(); } });
  pad.appendChild(clear);
}

function onPadPress(n){
  if(focusedIdx === null) return showToast(t('selectCell'));
  if(currentGrid[focusedIdx].fixed) return;
  currentGrid[focusedIdx].value = n;
  renderGrid();
}

/* VALIDACIÓN DETALLADA:
   - Cada fila se evalúa como una expresión left-to-right usando una secuencia de operadores
     determinada por posicion para reproducibilidad (no aleatoria en validación).
   - Acepta resultados enteros; para división exige que el resultado sea entero y que no haya división por cero.
   - Rechaza si alguna celda está vacía.
   - Retorna {valid:boolean, reason?:string}
*/
function validatePuzzle(){
  const nulls = currentGrid.filter(c=>c.value===null);
  if(nulls.length>0) return { valid:false, reason:'Faltan celdas por rellenar' };
  for(let r=0;r<gridSize;r++){
    let val = currentGrid[r*gridSize].value;
    for(let c=1;c<gridSize;c++){
      const cellVal = currentGrid[r*gridSize + c].value;
      const op = operatorSet[(r + c) % operatorSet.length];
      if(op === '+') val = val + cellVal;
      else if(op === '-') val = val - cellVal;
      else if(op === '*') val = val * cellVal;
      else if(op === '/'){
        if(cellVal === 0) return { valid:false, reason:'División por cero' };
        const res = val / cellVal;
        if(Math.abs(res - Math.round(res)) > 0.0001) return { valid:false, reason:'División no entera' };
        val = res;
      }
    }
    if(Math.abs(val - Math.round(val)) > 0.0001){
      return { valid:false, reason:'Resultado no entero en fila ' + (r+1) };
    }
  }
  return { valid:true };
}

document.getElementById('validateBtn').addEventListener('click', ()=>{
  const res = validatePuzzle();
  if(res.valid){
    currentScore += 100;
    document.getElementById('scoreLabel').textContent = 'Puntos: ' + currentScore;
    runConfetti();
    showToast('¡Correcto!');
  } else {
    showToast('Incorrecto: ' + res.reason);
  }
});

/* ====== Guardado/Carga y botones ====== */
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  await saveProgress(currentPuzzleState());
});
document.getElementById('backToMenu').addEventListener('click', ()=> show('menu'));

/* ====== Estado del puzzle para persistencia ====== */
function currentPuzzleState(){
  return {
    level: activeLevel,
    gridSize,
    operatorSet,
    grid: currentGrid,
    score: currentScore,
    puzzlesUsed: [], // opcional: tracking
    updatedAt: Date.now()
  };
}

/* ====== Timer ====== */
function resetTimer(){
  clearInterval(timerInterval);
  startTime = Date.now();
  document.getElementById('timer').textContent = '00:00';
}
function startTimer(){
  timerInterval = setInterval(()=>{
    const diff = Math.floor((Date.now() - startTime)/1000);
    const mm = String(Math.floor(diff/60)).padStart(2,'0');
    const ss = String(diff%60).padStart(2,'0');
    document.getElementById('timer').textContent = `${mm}:${ss}`;
  }, 500);
}

/* ====== Confetti ligero ====== */
const confettiCanvas = document.getElementById('confetti');
confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight;
const confettiCtx = confettiCanvas.getContext('2d');
let confettis = [];
function runConfetti(){
  for(let i=0;i<80;i++){
    confettis.push({x: Math.random()*innerWidth, y: -20, vx:(Math.random()-0.5)*4, vy:Math.random()*4+2, s:Math.random()*6+4, col: `hsl(${Math.random()*360} 80% 60%)`});
  }
  requestAnimationFrame(confettiLoop);
  setTimeout(()=> confettis = [], 3500);
}
function confettiLoop(){
  confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  for(const p of confettis){
    p.x += p.vx; p.y += p.vy; p.vy += 0.08;
    confettiCtx.fillStyle = p.col;
    confettiCtx.fillRect(p.x, p.y, p.s, p.s*0.6);
  }
  confettis = confettis.filter(p=>p.y < innerHeight+50);
  if(confettis.length) requestAnimationFrame(confettiLoop);
}

/* ====== Fondo de partículas ligero (animado) ====== */
const particles = document.getElementById('particles');
particles.width = innerWidth; particles.height = innerHeight;
const pctx = particles.getContext('2d');
const parts = [];
for(let i=0;i<60;i++){
  parts.push({x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: Math.random()*2+0.6, vx:(Math.random()-0.5)*0.3, vy:(Math.random()-0.5)*0.3, a: Math.random()});
}
function partLoop(){
  pctx.clearRect(0,0,particles.width,particles.height);
  for(const p of parts){
    p.x += p.vx; p.y += p.vy; p.a += 0.01;
    if(p.x < -10) p.x = innerWidth+10; if(p.x > innerWidth+10) p.x = -10;
    if(p.y < -10) p.y = innerHeight+10; if(p.y > innerHeight+10) p.y = -10;
    pctx.fillStyle = `rgba(155,200,255,${0.06 + Math.abs(Math.sin(p.a))*0.08})`;
    pctx.beginPath(); pctx.arc(p.x,p.y,p.r,0,Math.PI*2); pctx.fill();
  }
  requestAnimationFrame(partLoop);
}
partLoop();

/* ====== Toast helper ====== */
const toastEl = document.getElementById('toast');
let toastTimer = null;
function showToast(msg, time=2500){
  toastEl.textContent = msg;
  toastEl.classList.remove('hidden');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toastEl.classList.add('hidden'); }, time);
}

/* ====== Niveles: wiring ====== */
document.querySelectorAll('.level-card').forEach(el=>{
  el.addEventListener('click', ()=> { startLevel(el.dataset.level); });
});

/* ====== startLevel ====== */
function startLevel(level){
  configureLevel(level);
  generatePuzzle(level);
  show('game');
  focusedIdx = currentGrid.findIndex(c=>!c.fixed);
  if(focusedIdx === -1) focusedIdx = null;
  resetTimer(); startTimer();
}

/* ====== Guardado automático al iniciar sesión: loadProgress conecta con save/load del txt ====== */
onAuthStateChanged(auth, async user => {
  if(user){
    const prog = await loadProgress();
    if(prog && prog.level){
      activeLevel = prog.level;
      gridSize = prog.gridSize || gridSize;
      currentGrid = prog.grid || currentGrid;
      currentScore = prog.score || 0;
      renderGrid();
      document.getElementById('scoreLabel').textContent = 'Puntos: ' + currentScore;
    }
  }
});

/* ====== UI inicial ====== */
window.addEventListener('resize', ()=>{ particles.width = innerWidth; particles.height = innerHeight; confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; });
show('menu');
showToast('CrossMathWeb listo. Reemplaza Firebase config por tu proyecto crossmath-sync-db.', 3500);

/* ====== Nota para desarrollador (seguridad & Gumroad webhook) ======
  - Reglas Firestore recomendadas:
    match /users/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;
    }
  - Implementa un backend que reciba el webhook de Gumroad; al validar compra del producto rnlle, busca el usuario por email
    en collection users (o guarda un mapping email->uid) y actualiza users/{uid}.isPremium = true usando Admin SDK.
  - El cliente redirige a Gumroad; la activación real viene desde el webhook del servidor.
======================================================================= */

</script>
</body>
</html>
