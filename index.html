<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossmath - Desaf칤o de N칰meros</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6018346455368636"
      crossorigin="anonymous"></script>
    
    <style>
        :root {
            --bg-color: #f0f0f0; --text-color: #333; --primary-color: #007bff;
            --secondary-color: #6c757d; --border-color: #ccc; --cell-bg-color: #fff;
            --input-bg-color: #f8f9fa; --invalid-input-bg: #ffcccc; --valid-input-bg: #ccffcc;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex;
            justify-content: center; align-items: center; min-height: 100vh; margin: 0;
            background-color: var(--bg-color); color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            text-align: center; background: #fff; padding: 2rem; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); max-width: 90%; width: 500px;
        }
        h1 { color: var(--primary-color); margin-bottom: 1rem; }
        .screen { display: none; flex-direction: column; align-items: center; gap: 15px; }
        .screen.active { display: flex; }
        .menu-button, .level-button {
            width: 80%; padding: 15px; font-size: 1.2rem; font-weight: bold; color: #fff;
            background-color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .menu-button:hover, .level-button:hover { background-color: #0056b3; transform: translateY(-2px); }
        .secondary-button { background-color: var(--secondary-color); }
        .secondary-button:hover { background-color: #5a6268; }
        .auth-form { width: 100%; display: flex; flex-direction: column; gap: 10px; }
        .auth-form input {
            padding: 12px; border: 1px solid var(--border-color); border-radius: 6px;
            font-size: 1rem; text-align: left; width: calc(100% - 24px);
        }
        #delete-account-section, #reset-data-section, #sync-data-section {
            width: 100%; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .warning-note {
            font-size: 0.85rem; color: red; margin-top: 10px; padding: 10px;
            background: #ffebeb; border-radius: 5px;
        }
        .purchase-instruction {
            font-size: 0.9em; color: var(--text-color); padding: 5px 0;
            max-width: 80%; text-align: center;
        }
        #language-select { margin-bottom: 1rem; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); }
        #game-board {
            display: grid; gap: 5px; margin-bottom: 1rem; justify-content: center; transition: all 0.3s ease;
        }
        .cell {
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; font-weight: bold; border-radius: 8px; background-color: var(--cell-bg-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); transition: all 0.2s ease;
        }
        .operand, .equals, .given { background-color: #e9ecef; color: #555; border: none; box-shadow: none; }
        .empty { background-color: var(--input-bg-color); }
        .empty.invalid { background-color: var(--invalid-input-bg); border: 2px solid red; }
        .empty.correct { background-color: var(--valid-input-bg); border: 2px solid green; }
        input {
            width: 100%; height: 100%; border: none; text-align: center; font-size: 1.2rem;
            font-weight: bold; background: transparent; outline: none; color: var(--text-color);
        }
        .level-select-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        .ad-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9);
            color: white; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; gap: 20px; font-size: 1.5rem; text-align: center;
        }
        #real-ad-container {
            background: white; padding: 10px; max-width: 90%; width: 320px; min-height: 50px;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .ad-button {
            padding: 10px 20px; background-color: #ffc107; color: #333; border: none;
            border-radius: 5px; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="title"></h1>
    <div id="auth-screen" class="screen">
        <h2 id="auth-title"></h2>
        <div id="auth-status-message"></div>
        <form id="auth-form" class="auth-form">
            <input type="email" id="auth-email" placeholder="Correo electr칩nico" required>
            <input type="password" id="auth-password" placeholder="Contrase침a" required>
            <button class="menu-button" type="submit" id="auth-submit-button"></button>
        </form>
        <button class="menu-button secondary-button" id="switch-auth-mode-button"></button>
        <button class="menu-button secondary-button" id="auth-back-button"></button>
    </div>
    <div id="main-menu" class="screen">
        <p id="welcome-message"></p>
        <button class="menu-button" id="play-button"></button>
        <button class="menu-button" id="stats-button"></button>
        <button class="menu-button" id="settings-button"></button>
        <button class="menu-button secondary-button" id="logout-button"></button>
    </div>
    <div id="level-select-screen" class="screen">
        <h2 id="level-select-title"></h2>
        <div class="level-select-grid">
            <button class="level-button" data-difficulty="easy">F치cil</button>
            <button class="level-button" data-difficulty="medium">Medio</button>
            <button class="level-button" data-difficulty="hard">Dif칤cil</button>
            <button class="level-button" data-difficulty="expert">Experto</button>
        </div>
        <button class="menu-button secondary-button" id="back-from-levels-button"></button>
    </div>
    <div id="game-screen" class="screen">
        <p id="game-info"></p>
        <div id="game-board"></div>
        <div id="result-message"></div>
        <button class="menu-button" id="check-button"></button>
        <button class="menu-button secondary-button" id="back-to-menu-button"></button>
    </div>
    <div id="stats-screen" class="screen">
        <h2 id="stats-title"></h2>
        <p id="games-completed"></p>
        <p id="success-rate"></p>
        <p id="average-time"></p>
        <div id="badges-container">
            <h2 id="badges-title"></h2>
            <div id="badges-list"></div>
        </div>
        <button class="menu-button secondary-button" id="back-from-stats-button"></button>
    </div>
    <div id="settings-screen" class="screen">
        <label id="language-label" for="language-select"></label>
        <select id="language-select"></select>
        <p id="purchase-instruction" class="purchase-instruction"></p>
        <button class="menu-button" id="premium-button"></button>
        <p id="premium-status"></p>
        <div id="sync-data-section">
            <h3>Sincronizaci칩n Multi-Dispositivo</h3>
            <p style="font-size: 0.9em; text-align: center;">Usa un PIN de 6 d칤gitos para guardar o cargar tu progreso.</p>
            <input type="number" id="sync-pin" placeholder="PIN de 6 d칤gitos" maxlength="6">
            <button class="menu-button" id="export-data-button">Guardar Progreso</button>
            <button class="menu-button secondary-button" id="import-data-button">Cargar Progreso</button>
            <div id="sync-message" class="warning-note" style="display: none;"></div>
        </div>
        <div id="reset-data-section">
            <h3 id="reset-title"></h3>
            <button class="menu-button secondary-button" id="clear-progress-button"></button>
        </div>
        <div id="delete-account-section">
            <h3 id="account-management-title"></h3>
            <p id="current-user-display"></p>
            <button class="menu-button secondary-button" id="delete-account-button"></button>
            <p id="reimbursement-note" class="warning-note"></p>
        </div>
        <button class="menu-button secondary-button" id="back-from-settings-button"></button>
    </div>
</div>
<div id="ad-popup" class="ad-screen" style="display: none;">
    <p id="ad-message"></p>
    <div id="real-ad-container"></div>
    <button class="ad-button" id="skip-ad-button"></button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

<script>
// CORRECCI칍N PRINCIPAL: Todo el c칩digo del juego ahora se ejecuta dentro de este listener,
// lo que garantiza que la p치gina y las librer칤as externas (Firebase) se hayan cargado primero.
document.addEventListener('DOMContentLoaded', () => {

    // -----------------------------------------------------------
    // 游띔 CONFIGURACI칍N DE FIREBASE (SE INICIA DE FORMA SEGURA) 游띔
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCKIUkOfSMOLIhuYcQ30rm1Uc6hg8MFJ04",
        authDomain: "crossmath-sync-db.firebaseapp.com",
        projectId: "crossmath-sync-db",
        storageBucket: "crossmath-sync-db.appspot.com",
        messagingSenderId: "170459630175",
        appId: "1:170459630175:web:6a2a4ccba5dad1fa0ee9ea",
        measurementId: "G-BBJKKN96SV"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // -----------------------------------------------------------
    // L칍GICA PRINCIPAL DEL JUEGO
    // -----------------------------------------------------------
    const GUMROAD_PAYMENT_URL = "https://anacristinacz.gumroad.com/l/rnlle";
    const translations = {
        es: {
            mainMenu: 'Men칰 Principal', play: 'Jugar', viewStats: 'Ver Estad칤sticas', settings: 'Configuraci칩n',
            levelCompleted: '춰Nivel Completado!', incorrect: 'Incorrecto. 춰Sigue intentando!',
            fillAllFields: 'Por favor, rellena todas las casillas.',
            gamesCompleted: 'Juegos Completados: {count}', successRate: 'Tasa de 칄xito: {rate}', averageTime: 'Tiempo Promedio: {time}',
            badges: 'Insignias',
            backToMenu: 'Volver al Men칰', language: 'Idioma', selectLevel: 'Selecciona un Nivel',
            easy: 'F치cil', medium: 'Medio', hard: 'Dif칤cil', expert: 'Experto',
            check: 'Comprobar',
            removeAds: 'Eliminar Anuncios',
            premiumPurchased: '춰Premium Activo! Disfruta sin anuncios.',
            adSupported: 'Con Anuncios',
            loginTitle: 'Iniciar Sesi칩n', registerTitle: 'Crear Cuenta',
            loginButton: 'Iniciar Sesi칩n', registerButton: 'Registrarme',
            loginSwitch: '쯅o tienes cuenta? Reg칤strate', registerSwitch: '쯏a tienes cuenta? Inicia Sesi칩n',
            authSuccess: '춰Bienvenido(a)!', authFailed: 'Credenciales inv치lidas.',
            userExists: 'El correo ya est치 registrado.', registrationSuccess: 'Cuenta creada. 춰Inicia Sesi칩n!',
            logout: 'Cerrar Sesi칩n', welcome: '춰Hola, {user}!',
            accountManagement: 'Gesti칩n de Cuenta', deleteAccount: 'Eliminar Cuenta',
            currentUser: 'Sesi칩n activa: {user}',
            deleteConfirm: '쮼st치s seguro? Esta acci칩n es PERMANENTE y borrar치 tu progreso.',
            deleteSuccess: 'Tu cuenta ha sido eliminada.',
            reimbursementNote: 'NOTA: La eliminaci칩n de la cuenta no conlleva el reembolso de la membres칤a Premium.',
            authBack: 'Volver al Inicio',
            purchaseInstruction: 'IMPORTANTE: Para activar Premium, la compra debe hacerse con el MISMO correo de tu cuenta.',
            resetTitle: 'Restablecer Progreso',
            clearProgress: 'Borrar Progreso del Juego',
            clearProgressConfirm: '쯉eguro que quieres borrar tus estad칤sticas? Tu Premium se mantendr치.',
            progressCleared: 'Progreso borrado.',
            syncSuccessExport: '칄XITO: Progreso guardado en la nube con PIN {pin}.',
            syncSuccessImport: '칄XITO: Datos cargados. La p치gina se actualizar치.',
            syncError: 'Error: El PIN debe tener 6 d칤gitos.',
            syncErrorNotFound: 'ERROR: No se encontraron datos para ese PIN.',
            syncErrorUserMismatch: 'ERROR: Este PIN no corresponde a tu usuario.'
        },
        en: {
            // Traducciones en ingl칠s (versi칩n simplificada para brevedad)
            mainMenu: 'Main Menu', play: 'Play', viewStats: 'Stats', settings: 'Settings',
            levelCompleted: 'Level Complete!', incorrect: 'Incorrect. Try again!',
            fillAllFields: 'Please fill all fields.',
            welcome: 'Hello, {user}!',
            logout: 'Log Out',
            // ... (se pueden a침adir el resto de traducciones)
        }
    };
    
    // Referencias a elementos del DOM
    const screens = {
        'auth': document.getElementById('auth-screen'),
        'main-menu': document.getElementById('main-menu'),
        'level-select': document.getElementById('level-select-screen'),
        'game': document.getElementById('game-screen'),
        'stats': document.getElementById('stats-screen'),
        'settings': document.getElementById('settings-screen')
    };
    const elements = {
        // ... (Se obtienen todos los elementos por ID de forma similar para mantener el c칩digo limpio)
        container: document.querySelector('.container'),
        // A침ade aqu칤 el resto de las referencias a 'elements' que tu l칩gica necesite
    };

    // Estado del juego
    let currentUserID = null;
    let currentUserData = {};
    let currentLang = 'es';
    let currentAuthMode = 'login';

    // Funciones de L칩gica de Cuentas y Datos
    function switchScreen(screenName) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[screenName].classList.add('active');
    }

    async function loadUserData(userId) {
        currentUserID = userId;
        localStorage.setItem('crossmath_active_user', userId);
        // Aqu칤 ir칤a la l칩gica para cargar los datos del usuario (stats, premium, etc.)
        // Por ahora, usamos un objeto vac칤o como placeholder
        currentUserData = { stats: { gamesCompleted: 0, gamesCorrect: 0 }, isPremium: false };
        updateUI();
        switchScreen('main-menu');
    }

    function logout() {
        currentUserID = null;
        currentUserData = {};
        localStorage.removeItem('crossmath_active_user');
        updateUI();
        switchScreen('auth');
    }
    
    // Funci칩n para actualizar toda la UI basada en el estado actual
    function updateUI() {
        const t = translations[currentLang];
        // Actualizar pantalla de autenticaci칩n
        document.getElementById('auth-title').textContent = currentAuthMode === 'login' ? t.loginTitle : t.registerTitle;
        document.getElementById('auth-submit-button').textContent = currentAuthMode === 'login' ? t.loginButton : t.registerButton;
        document.getElementById('switch-auth-mode-button').textContent = currentAuthMode === 'login' ? t.loginSwitch : t.registerSwitch;

        // Actualizar men칰 principal
        if (currentUserID) {
            document.getElementById('welcome-message').textContent = t.welcome.replace('{user}', currentUserID);
            document.getElementById('logout-button').style.display = 'block';
        } else {
            document.getElementById('welcome-message').textContent = '';
            document.getElementById('logout-button').style.display = 'none';
        }
        
        // ... aqu칤 ir칤an el resto de las actualizaciones de UI (botones, textos, etc.)
        document.getElementById('play-button').textContent = t.play;
        document.getElementById('stats-button').textContent = t.viewStats;
        document.getElementById('settings-button').textContent = t.settings;
    }

    // L칩gica de Autenticaci칩n
    document.getElementById('auth-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const t = translations[currentLang];
        const messageEl = document.getElementById('auth-status-message');

        // Esta es una simulaci칩n. En una app real, usar칤as Firebase Auth.
        if (currentAuthMode === 'register') {
            // Simulaci칩n de registro
            if (localStorage.getItem('user_' + email)) {
                messageEl.textContent = t.userExists;
            } else {
                localStorage.setItem('user_' + email, password);
                messageEl.textContent = t.registrationSuccess;
                currentAuthMode = 'login';
                updateUI();
            }
        } else {
            // Simulaci칩n de login
            const storedPassword = localStorage.getItem('user_' + email);
            if (storedPassword && storedPassword === password) {
                await loadUserData(email);
            } else {
                messageEl.textContent = t.authFailed;
            }
        }
    });

    document.getElementById('switch-auth-mode-button').addEventListener('click', () => {
        currentAuthMode = currentAuthMode === 'login' ? 'register' : 'login';
        updateUI();
    });

    document.getElementById('logout-button').addEventListener('click', logout);


    // L칩gica de Navegaci칩n
    document.getElementById('play-button').addEventListener('click', () => switchScreen('level-select'));
    document.getElementById('stats-button').addEventListener('click', () => switchScreen('stats'));
    document.getElementById('settings-button').addEventListener('click', () => switchScreen('settings'));
    document.getElementById('back-from-levels-button').addEventListener('click', () => switchScreen('main-menu'));
    document.getElementById('back-from-stats-button').addEventListener('click', () => switchScreen('main-menu'));
    document.getElementById('back-from-settings-button').addEventListener('click', () => switchScreen('main-menu'));


    // -----------------------------------------------------------
    // INICIO DEL JUEGO
    // -----------------------------------------------------------
    
    // Verificar si hay un usuario activo guardado
    const activeUser = localStorage.getItem('crossmath_active_user');
    if (activeUser) {
        loadUserData(activeUser);
    } else {
        switchScreen('auth');
    }

    updateUI(); // Llamada inicial para establecer los textos correctos
});
</script>

</body>
</html>
