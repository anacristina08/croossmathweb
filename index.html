<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cross Math — Web Local</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f1a; --card:#101625; --line:#1c2135;
      --text:#e6edf3; --muted:#9aa7bd;
      --blue:#2f7bff; --blue-400:#4c8aff;
      --green:#22c55e; --red:#ef4444; --yellow:#facc15;
      --tile:#2a3550; --tile-blank:#f8e77a; --tile-op:#1b2238; --tile-num:#172038;
      --shadow:0 6px 22px rgba(31,95,230,0.18);
      --soft:0 6px 22px rgba(0,0,0,0.16);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(29,43,92,0.14), transparent 60%),
        linear-gradient(180deg, #0b0f1a, #0d1422 60%, #0b0f1a);
    }
    a{color:var(--blue);text-decoration:none}
    button{
      appearance:none;border:none;cursor:pointer;font-weight:700;border-radius:12px;padding:12px 16px;
      transition:filter .15s ease, transform .05s ease;
    }
    button:active{transform:translateY(1px)}
    .btn-blue{background:var(--blue);color:#fff;box-shadow:var(--shadow)}
    .btn-blue:hover{filter:brightness(1.06)}
    .btn-outline{background:var(--card);color:var(--text);border:1px solid var(--line)}
    .btn-ghost{background:transparent;color:var(--text)}
    .container{max-width:960px;margin:0 auto;padding:20px}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;border-bottom:1px solid var(--line);background:#0d1322cc; backdrop-filter:blur(8px); position:sticky; top:0; z-index:10;
    }
    .brand{font-weight:900;letter-spacing:.2px}
    .userbar{display:flex;align-items:center;gap:8px;color:var(--muted)}

    /* Home cards */
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:var(--soft);
    }
    .home-group{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
    .title-main{text-align:center;margin:24px 0 12px;font-weight:900;font-size:28px}
    .home-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:520px;margin:0 auto}

    /* HUD + Crucigrama & bank */
    .hud{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin:16px 0;
      background:#0d1422; border:1px solid var(--line); border-radius:14px; padding:10px 12px;
    }
    .stat{display:flex;align-items:center;gap:8px;color:var(--muted)}
    .stat strong{color:var(--text)}

    /* Grid 5x5 */
    .grid{
      display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
      background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px;
    }
    .cell{
      min-height:72px; display:flex; align-items:center; justify-content:center;
      border:1px solid var(--line); border-radius:12px; font-weight:800; font-size:20px; letter-spacing:.2px; text-align:center;
      background:var(--tile); color:#cfe3ff; position:relative;
    }
    .cell.op{ background:var(--tile-op); color:#9fb0d7; }
    .cell.num{ background:var(--tile-num); color:#e6edf3; }
    .cell.blank{ background:var(--tile-blank); color:#121212; cursor:pointer; outline:2px dashed #e0c54e; }
    .cell.ok{ background:#0f5132; color:#eafff2; border-color:#127a4e; }
    .cell.err{ background:#6f1d1d; color:#ffeaea; border-color:#a32b2b; }
    .eq-label{position:absolute;bottom:6px;right:8px;color:#9fb0d7;font-weight:700;font-size:12px}

    .bank{
      display:grid; grid-template-columns:repeat(8,1fr); gap:8px;
      background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; margin-top:12px;
    }
    .tile{
      padding:12px; text-align:center; font-weight:900; border-radius:10px; user-select:none;
      border:1px solid var(--line); background:#14325e; color:#e6edf3; box-shadow:0 6px 18px rgba(20,50,94,.25);
    }
    .tile:hover{ filter:brightness(1.08) }
    .tile.used{ opacity:.35; pointer-events:none }

    .msg{margin-top:8px;font-size:14px;color:var(--muted)}
    .msg.ok{color:var(--green)}
    .msg.err{color:var(--red)}

    /* Modals & overlays */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:100}
    .modal{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;width:100%;max-width:520px;box-shadow:var(--soft)}
    .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#0d1322;color:var(--text);font-weight:600}

    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:90}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;width:100%;max-width:520px;box-shadow:var(--soft);text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">Cross Math</div>
    <div class="userbar">
      <span id="userStatus">Sin sesión</span>
      <button id="loginOpenBtn" class="btn-outline">Acceso</button>
      <button id="logoutBtn" class="btn-outline" style="display:none;">Salir</button>
    </div>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="homeScreen">
      <div class="home-group">
        <div class="card">
          <h3>Daily Challenge</h3>
          <div class="muted" id="dailyDate"></div>
          <div class="flex" style="gap:8px;margin-top:8px;">
            <button id="playDailyBtn" class="btn-blue">Play</button>
          </div>
        </div>
        <div class="card">
          <h3>Endless Mode</h3>
          <div class="muted">Highest score: <span id="endlessBest">0</span></div>
          <div class="flex" style="gap:8px;margin-top:8px;">
            <button id="playEndlessBtn" class="btn-blue">Play</button>
          </div>
        </div>
      </div>

      <div class="title-main">Cross Math</div>

      <div class="home-actions">
        <button id="continueBtn" class="btn-blue" style="display:none;">Continue</button>
        <button id="newGameBtn" class="btn-outline">New Game</button>
      </div>

      <div class="card" style="margin-top:24px;">
        <h3>Perfil</h3>
        <p class="muted">Premium desbloquea todo. Solo se compra la versión Premium.</p>
        <div class="flex" style="gap:8px;">
          <button id="buyPremiumBtn" class="btn-blue">Comprar Premium</button>
          <input id="gumroadLicenseInput" class="input" placeholder="Licencia Gumroad (rnlle)" />
          <button id="verifyLicenseBtn" class="btn-outline">Verificar licencia</button>
        </div>
        <p class="muted" style="margin-top:8px;">Cuenta demo: premium_demo@crossmath.com / demo123 (Premium activado)</p>
        <div class="flex" style="gap:8px;margin-top:10px;">
          <button id="exportBtn" class="btn-outline">Exportar JSON</button>
          <label for="importInput" class="btn-outline" style="cursor:pointer;">Importar JSON</label>
          <input id="importInput" type="file" accept="application/json" style="display:none;" />
        </div>
        <div id="profileInfo" class="muted" style="margin-top:8px;">Inicia sesión para ver tu estado.</div>
      </div>

      <div class="card">
        <h3>Ajustes</h3>
        <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label class="muted">Idioma</label>
            <select id="langSelect" class="input">
              <option value="es">Español</option><option value="en">English</option><option value="fr">Français</option><option value="de">Deutsch</option>
              <option value="it">Italiano</option><option value="pt">Português</option><option value="ru">Русский</option><option value="zh">中文</option>
              <option value="ja">日本語</option><option value="ko">한국어</option><option value="ar">العربية</option><option value="hi">हिन्दी</option>
              <option value="tr">Türkçe</option><option value="pl">Polski</option><option value="nl">Nederlands</option>
            </select>
          </div>
          <div>
            <label class="muted">Sonido</label>
            <button id="toggleSoundBtn" class="btn-outline">Sonido: ON</button>
          </div>
        </div>
      </div>
    </section>

    <!-- LEVEL SELECT (Expert, solo Premium) -->
    <section id="levelSelectScreen" style="display:none;">
      <div class="card">
        <h3>Expert</h3>
        <p class="muted">Selecciona etapa (1–15). Requiere Premium.</p>
        <div id="levelGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;"></div>
        <div class="flex" style="gap:8px;margin-top:12px;">
          <button id="backHomeBtn" class="btn-outline">Back</button>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section id="gameScreen" style="display:none;">
      <div class="hud">
        <div class="stat"><strong>Modo:</strong> <span id="hudMode">Daily</span></div>
        <div class="stat"><strong>Tiempo:</strong> <span id="hudTime">00:00</span></div>
        <div class="stat"><strong>Vidas:</strong> <span id="hudLives">3</span></div>
        <div class="stat"><strong>Monedas:</strong> <span id="hudCoins">0</span></div>
        <div class="flex" style="gap:8px;">
          <button id="pauseBtn" class="btn-outline">Pause</button>
          <button id="restartBtn" class="btn-outline">Restart</button>
          <button id="exitBtn" class="btn-outline">Exit</button>
        </div>
      </div>

      <div class="grid" id="puzzleGrid"></div>
      <div class="bank" id="numberBank"></div>
      <div id="gameMsg" class="msg"></div>
    </section>
  </main>

  <!-- AUTH MODAL -->
  <div id="authBackdrop" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h3>Acceso</h3>
        <p class="muted">Crea cuenta o inicia sesión. Todo se guarda localmente.</p>
      </header>
      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div><label class="muted">Usuario / Email</label><input id="authUser" class="input" placeholder="premium_demo@crossmath.com" /></div>
        <div><label class="muted">Contraseña</label><input id="authPass" type="password" class="input" placeholder="••••••••" /></div>
      </div>
      <div id="authMsg" class="msg"></div>
      <div class="flex" style="gap:8px;margin-top:12px;">
        <button id="registerBtn" class="btn-outline">Registrar</button>
        <button id="loginBtnModal" class="btn-blue">Entrar</button>
        <button id="closeAuthBtn" class="btn-outline">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- OVERLAYS -->
  <div id="pauseOverlay" class="overlay"><div class="panel">
    <h3>Pausa</h3>
    <div class="flex" style="justify-content:center;gap:8px;">
      <button id="resumeBtn" class="btn-blue">Continuar</button>
      <button id="restartFromPauseBtn" class="btn-outline">Reiniciar</button>
      <button id="exitFromPauseBtn" class="btn-outline">Salir</button>
    </div>
  </div></div>

  <div id="completeOverlay" class="overlay"><div class="panel">
    <h3>Nivel completado</h3>
    <p class="muted">Puntaje: <span id="finalScore">0</span></p>
    <div class="flex" style="justify-content:center;gap:8px;">
      <button id="continueAfterCompleteBtn" class="btn-blue">Continue</button>
      <button id="replayBtn" class="btn-outline">Replay</button>
    </div>
  </div></div>

  <div id="gameOverOverlay" class="overlay"><div class="panel">
    <h3>Game Over</h3>
    <p class="muted">Sin vidas. Intenta de nuevo o vuelve al menú.</p>
    <div class="flex" style="justify-content:center;gap:8px;">
      <button id="retryBtn" class="btn-blue">Retry</button>
      <button id="goHomeBtn" class="btn-outline">Menu</button>
    </div>
  </div></div>

  <script>
    // Premium (solo se compra Premium, todo lo demás incluido con Premium)
    const GUMROAD_PRODUCT_ID='rnlle';
    const GUMROAD_URL='https://anacristinacz.gumroad.com/l/rnlle';

    // Estado global y DB
    let db=null, currentUser=null, premium=false, lives=3, coins=0, elapsed=0, timerInt=null;
    let currentMode='Daily', currentStage=1;
    let selected=null;

    // Crucigrama state
    // grid[r][c] = {kind:'op'|'num'|'blank'|'empty', text?, id?, value?, solution?}
    // equations: [{type:'row'|'col', cells:[{r,c}], ops:[...], target:..., label?}]
    let state={ grid:[], bank:[], blanks:[], equations:[] };

    // IndexedDB
    const DB_NAME='crossmath-local', DB_VERSION=1;
    async function openDB(){
      return new Promise((resolve,reject)=>{
        const req=indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded=e=>{
          const d=e.target.result;
          if(!d.objectStoreNames.contains('users')) d.createObjectStore('users',{keyPath:'username'});
          if(!d.objectStoreNames.contains('progress')) d.createObjectStore('progress',{keyPath:'username'});
          if(!d.objectStoreNames.contains('meta')) d.createObjectStore('meta',{keyPath:'username'});
        };
        req.onsuccess=()=>{db=req.result;resolve(db)};
        req.onerror=()=>reject(req.error);
      });
    }
    function store(name,mode='readonly'){return db.transaction(name,mode).objectStore(name)}
    function getUser(u){return new Promise((res,rej)=>{const q=store('users').get(u);q.onsuccess=()=>res(q.result||null);q.onerror=()=>rej(q.error)})}
    function putUser(u){return new Promise((res,rej)=>{const q=store('users','readwrite').put(u);q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error)})}
    function getProgress(u){return new Promise((res,rej)=>{const q=store('progress').get(u);q.onsuccess=()=>res(q.result||{username:u,dailyBest:0,endlessBest:0,expert:{},lastSaved:null,scores:[]});q.onerror=()=>rej(q.error)})}
    function putProgress(p){return new Promise((res,rej)=>{const q=store('progress','readwrite').put(p);q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error)})}
    function getMeta(u){return new Promise((res,rej)=>{const q=store('meta').get(u);q.onsuccess=()=>res(q.result||{username:u,premium:false,coins:0,lives:3,sound:true,lang:(navigator.language||'es').slice(0,2)});q.onerror=()=>rej(q.error)})}
    function putMeta(m){return new Promise((res,rej)=>{const q=store('meta','readwrite').put(m);q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error)})}
    // Utilidades
    async function hashPassword(p){
      const enc=new TextEncoder();const d=enc.encode(p);
      const dig=await crypto.subtle.digest('SHA-256',d);
      return Array.from(new Uint8Array(dig)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function fmtDate(d){return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'})}
    function fmtTime(sec){
      const m=String(Math.floor(sec/60)).padStart(2,'0');
      const s=String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }
    function startTimer(){
      stopTimer();elapsed=0;
      document.getElementById('hudTime').textContent=fmtTime(elapsed);
      timerInt=setInterval(()=>{
        elapsed++;
        document.getElementById('hudTime').textContent=fmtTime(elapsed);
      },1000);
    }
    function stopTimer(){if(timerInt){clearInterval(timerInt);timerInt=null}}

    // Generador de crucigrama fijo 5x5
    function generatePuzzle(){
      const g=Array.from({length:5},()=>Array.from({length:5},()=>({kind:'empty',text:''})));
      // Fila 0: 3+5=8
      g[0][0]={kind:'blank',id:'a',text:'□'};
      g[0][1]={kind:'op',text:'+'};
      g[0][2]={kind:'blank',id:'b',text:'□'};
      g[0][3]={kind:'op',text:'='};
      g[0][4]={kind:'num',text:'8'};
      // Fila 2: 7-5=2
      g[2][0]={kind:'blank',id:'c',text:'□'};
      g[2][1]={kind:'op',text:'-'};
      g[2][2]={kind:'blank',id:'d',text:'□'};
      g[2][3]={kind:'op',text:'='};
      g[2][4]={kind:'num',text:'2'};
      // Fila 4: 6÷2=3
      g[4][0]={kind:'num',text:'6'};
      g[4][1]={kind:'op',text:'÷'};
      g[4][2]={kind:'blank',id:'e',text:'□'};
      g[4][3]={kind:'op',text:'='};
      g[4][4]={kind:'num',text:'3'};

      const solutions={a:3,b:5,c:7,d:5,e:2};

      const equations=[
        {type:'row',cells:[{r:0,c:0},{r:0,c:2}],ops:['+'],target:8},
        {type:'row',cells:[{r:2,c:0},{r:2,c:2}],ops:['-'],target:2},
        {type:'row',cells:[{r:4,c:2}],ops:['div-left'],target:{left:6,right:3}},
        {type:'col',cells:[{r:0,c:0},{r:2,c:0}],ops:['×'],target:21},
        {type:'col',cells:[{r:0,c:2},{r:2,c:2},{r:4,c:2}],ops:['+','+'],target:12}
      ];

      const blanks=[];
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const cell=g[r][c];
          if(cell.kind==='blank'){
            cell.value=null;
            cell.solution=solutions[cell.id];
            blanks.push({r,c,id:cell.id});
          }
        }
      }

      const bankSet=new Set(Object.values(solutions));
      while(bankSet.size<12){bankSet.add(Math.floor(Math.random()*30)+1);}
      const bank=Array.from(bankSet).sort((a,b)=>a-b);

      return {grid:g,bank,blanks,equations};
    }

    function evalEquation(eq,grid){
      const vals=eq.cells.map(pos=>grid[pos.r][pos.c].value);
      if(vals.some(v=>v==null)) return {ready:false,ok:false};
      if(eq.type==='row'){
        if(eq.ops[0]==='div-left'){
          const v=vals[0];
          return {ready:true,ok:(eq.target.left/v)===eq.target.right};
        }
        let acc=vals[0];
        for(let i=0;i<eq.ops.length;i++){
          const op=eq.ops[i],next=vals[i+1];
          if(op==='+') acc+=next;
          else if(op==='-') acc-=next;
          else if(op==='×') acc*=next;
          else if(op==='÷') acc/=next;
        }
        return {ready:true,ok:acc===eq.target};
      }else{
        let acc=vals[0];
        for(let i=0;i<eq.ops.length;i++){
          const op=eq.ops[i],next=vals[i+1];
          if(op==='+') acc+=next;
          else if(op==='-') acc-=next;
          else if(op==='×') acc*=next;
          else if(op==='÷') acc/=next;
        }
        return {ready:true,ok:acc===eq.target};
      }
    }

    function renderPuzzle(){
      const gridEl=document.getElementById('puzzleGrid');
      const bankEl=document.getElementById('numberBank');
      const msgEl=document.getElementById('gameMsg');
      gridEl.innerHTML=''; bankEl.innerHTML=''; msgEl.textContent='';

      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const cell=state.grid[r][c];
          const el=document.createElement('div');
          el.className='cell';
          if(cell.kind==='op'){el.classList.add('op');el.textContent=cell.text;}
          else if(cell.kind==='num'){el.classList.add('num');el.textContent=cell.text;}
          else if(cell.kind==='blank'){
            el.classList.add('blank');
            el.textContent=cell.value==null?'□':String(cell.value);
            el.addEventListener('click',()=>{selected={r,c};highlightSelection(r,c);});
          }else{el.textContent='';}
          if(r===0&&c===4){const lab=document.createElement('div');lab.className='eq-label';lab.textContent='=8';el.appendChild(lab);}
          if(r===2&&c===4){const lab=document.createElement('div');lab.className='eq-label';lab.textContent='=2';el.appendChild(lab);}
          if(r===4&&c===4){const lab=document.createElement('div');lab.className='eq-label';lab.textContent='=3';el.appendChild(lab);}
          gridEl.appendChild(el);
        }
      }

      state.bank.forEach(n=>{
        const t=document.createElement('div');
        t.className='tile';t.textContent=n;
        t.addEventListener('click',()=>placeNumber(n));
        bankEl.appendChild(t);
      });
    }

    function highlightSelection(sr,sc){
      const gridEl=document.getElementById('puzzleGrid');
      [...gridEl.children].forEach((el,i)=>{
        const r=Math.floor(i/5),c=i%5;
        if(r===sr&&c===sc) el.style.outline='2px solid #4c8aff';
        else{
          const cell=state.grid[r][c];
          el.style.outline=cell.kind==='blank'?'2px dashed #3a4a7c':'none';
        }
      });
    }

    function placeNumber(n){
      const msgEl=document.getElementById('gameMsg');
      if(!selected){msgEl.textContent='Selecciona una casilla';msgEl.className='msg err';return;}
      const {r,c}=selected;
      const cell=state.grid[r][c];
      if(cell.kind!=='blank') return;
      cell.value=n;
      renderPuzzle();
      const related=state.equations.filter(eq=>eq.cells.some(pos=>pos.r===r&&pos.c===c));
      let anyBad=false;
      for(const eq of related){
        const res=evalEquation(eq,state.grid);
        if(res.ready&&!res.ok){anyBad=true;break;}
      }
      const gridEl=document.getElementById('puzzleGrid');
      const idx=r*5+c;const cellEl=gridEl.children[idx];
      cellEl.classList.remove('ok','err');
      if(anyBad){
        cellEl.classList.add('err');
        msgEl.textContent='Incorrecto para el cruce.';msgEl.className='msg err';
        loseLife();
      }else{
        cellEl.classList.add('ok');
        msgEl.textContent='
           // Utilidades
    async function hashPassword(p){
      const enc=new TextEncoder();const d=enc.encode(p);
      const dig=await crypto.subtle.digest('SHA-256',d);
      return Array.from(new Uint8Array(dig)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function fmtDate(d){return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'})}
    function fmtTime(sec){
      const m=String(Math.floor(sec/60)).padStart(2,'0');
      const s=String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }
    function startTimer(){
      stopTimer();elapsed=0;
      document.getElementById('hudTime').textContent=fmtTime(elapsed);
      timerInt=setInterval(()=>{
        elapsed++;
        document.getElementById('hudTime').textContent=fmtTime(elapsed);
      },1000);
    }
    function stopTimer(){if(timerInt){clearInterval(timerInt);timerInt=null}}

    // Generador de crucigrama fijo 5x5
    function generatePuzzle(){
      const g=Array.from({length:5},()=>Array.from({length:5},()=>({kind:'empty',text:''})));
      // Fila 0: 3+5=8
      g[0][0]={kind:'blank',id:'a',text:'□'};
      g[0][1]={kind:'op',text:'+'};
      g[0][2]={kind:'blank',id:'b',text:'□'};
      g[0][3]={kind:'op',text:'='};
      g[0][4]={kind:'num',text:'8'};
      // Fila 2: 7-5=2
      g[2][0]={kind:'blank',id:'c',text:'□'};
      g[2][1]={kind:'op',text:'-'};
      g[2][2]={kind:'blank',id:'d',text:'□'};
      g[2][3]={kind:'op',text:'='};
      g[2][4]={kind:'num',text:'2'};
      // Fila 4: 6÷2=3
      g[4][0]={kind:'num',text:'6'};
      g[4][1]={kind:'op',text:'÷'};
      g[4][2]={kind:'blank',id:'e',text:'□'};
      g[4][3]={kind:'op',text:'='};
      g[4][4]={kind:'num',text:'3'};

      const solutions={a:3,b:5,c:7,d:5,e:2};

      const equations=[
        {type:'row',cells:[{r:0,c:0},{r:0,c:2}],ops:['+'],target:8},
        {type:'row',cells:[{r:2,c:0},{r:2,c:2}],ops:['-'],target:2},
        {type:'row',cells:[{r:4,c:2}],ops:['div-left'],target:{left:6,right:3}},
        {type:'col',cells:[{r:0,c:0},{r:2,c:0}],ops:['×'],target:21},
        {type:'col',cells:[{r:0,c:2},{r:2,c:2},{r:4,c:2}],ops:['+','+'],target:12}
      ];

      const blanks=[];
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const cell=g[r][c];
          if(cell.kind==='blank'){
            cell.value=null;
            cell.solution=solutions[cell.id];
            blanks.push({r,c,id:cell.id});
          }
        }
      }

      const bankSet=new Set(Object.values(solutions));
      while(bankSet.size<12){bankSet.add(Math.floor(Math.random()*30)+1);}
      const bank=Array.from(bankSet).sort((a,b)=>a-b);

      return {grid:g,bank,blanks,equations};
    }

    function evalEquation(eq,grid){
      const vals=eq.cells.map(pos=>grid[pos.r][pos.c].value);
      if(vals.some(v=>v==null)) return {ready:false,ok:false};
      if(eq.type==='row'){
        if(eq.ops[0]==='div-left'){
          const v=vals[0];
          return {ready:true,ok:(eq.target.left/v)===eq.target.right};
        }
        let acc=vals[0];
        for(let i=0;i<eq.ops.length;i++){
          const op=eq.ops[i],next=vals[i+1];
          if(op==='+') acc+=next;
          else if(op==='-') acc-=next;
          else if(op==='×') acc*=next;
          else if(op==='÷') acc/=next;
        }
        return {ready:true,ok:acc===eq.target};
      }else{
        let acc=vals[0];
        for(let i=0;i<eq.ops.length;i++){
          const op=eq.ops[i],next=vals[i+1];
          if(op==='+') acc+=next;
          else if(op==='-') acc-=next;
          else if(op==='×') acc*=next;
          else if(op==='÷') acc/=next;
        }
        return {ready:true,ok:acc===eq.target};
      }
    }

    function renderPuzzle(){
      const gridEl=document.getElementById('puzzleGrid');
      const bankEl=document.getElementById('numberBank');
      const msgEl=document.getElementById('gameMsg');
      gridEl.innerHTML=''; bankEl.innerHTML=''; msgEl.textContent='';

      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const cell=state.grid[r][c];
          const el=document.createElement('div');
          el.className='cell';
          if(cell.kind==='op'){el.classList.add('op');el.textContent=cell.text;}
          else if(cell.kind==='num'){el.classList.add('num');el.textContent=cell.text;}
          else if(cell.kind==='blank'){
            el.classList.add('blank');
            el.textContent=cell.value==null?'□':String(cell.value);
            el.addEventListener('click',()=>{selected={r,c};highlightSelection(r,c);});
          }else{el.textContent='';}
          if(r===0&&c===4){const lab=document.createElement('div');lab.className='eq-label';lab.textContent='=8';el.appendChild(lab);}
          if(r===2&&c===4){const lab=document.createElement('div');lab.className='eq-label';lab.textContent='=2';el.appendChild(lab);}
          if(r===4&&c===4){const lab=document.createElement('div');lab.className='eq-label';lab.textContent='=3';el.appendChild(lab);}
          gridEl.appendChild(el);
        }
      }

      state.bank.forEach(n=>{
        const t=document.createElement('div');
        t.className='tile';t.textContent=n;
        t.addEventListener('click',()=>placeNumber(n));
        bankEl.appendChild(t);
      });
    }

    function highlightSelection(sr,sc){
      const gridEl=document.getElementById('puzzleGrid');
      [...gridEl.children].forEach((el,i)=>{
        const r=Math.floor(i/5),c=i%5;
        if(r===sr&&c===sc) el.style.outline='2px solid #4c8aff';
        else{
          const cell=state.grid[r][c];
          el.style.outline=cell.kind==='blank'?'2px dashed #3a4a7c':'none';
        }
      });
    }

    function placeNumber(n){
      const msgEl=document.getElementById('gameMsg');
      if(!selected){msgEl.textContent='Selecciona una casilla';msgEl.className='msg err';return;}
      const {r,c}=selected;
      const cell=state.grid[r][c];
      if(cell.kind!=='blank') return;
      cell.value=n;
      renderPuzzle();
      const related=state.equations.filter(eq=>eq.cells.some(pos=>pos.r===r&&pos.c===c));
      let anyBad=false;
      for(const eq of related){
        const res=evalEquation(eq,state.grid);
        if(res.ready&&!res.ok){anyBad=true;break;}
      }
      const gridEl=document.getElementById('puzzleGrid');
      const idx=r*5+c;const cellEl=gridEl.children[idx];
      cellEl.classList.remove('ok','err');
      if(anyBad){
        cellEl.classList.add('err');
        msgEl.textContent='Incorrecto para el cruce.';msgEl.className='msg err';
        loseLife();
      }else{
        cellEl.classList.add('ok');
        msgEl.textContent='   
