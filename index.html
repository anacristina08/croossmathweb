<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossmath - Desaf√≠o de N√∫meros</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6018346455368636"
      crossorigin="anonymous"></script>
    
    <style>
        :root {
            --bg-color: #f0f0f0;
            --text-color: #333;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --border-color: #ccc;
            --cell-bg-color: #fff;
            --input-bg-color: #f8f9fa;
            --invalid-input-bg: #ffcccc;
            --valid-input-bg: #ccffcc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            text-align: center;
            background: #fff;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 500px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .screen.active {
            display: flex;
        }

        .menu-button, .level-button {
            width: 80%;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .menu-button:hover, .level-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .secondary-button {
            background-color: var(--secondary-color);
        }
        .secondary-button:hover {
            background-color: #5a6268;
        }
        
        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .auth-form input {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            text-align: left;
            width: calc(100% - 24px);
        }

        #delete-account-section, #reset-data-section, #sync-data-section {
            width: 100%;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .warning-note {
            font-size: 0.85rem;
            color: red;
            margin-top: 10px;
            padding: 10px;
            background: #ffebeb;
            border-radius: 5px;
        }

        .purchase-instruction {
            font-size: 0.9em;
            color: var(--text-color);
            padding: 5px 0;
            max-width: 80%;
            text-align: center;
        }

        #language-select {
            margin-bottom: 1rem;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        #game-board {
            display: grid;
            gap: 5px;
            margin-bottom: 1rem;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .cell {
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
            background-color: var(--cell-bg-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .operand, .equals, .given {
            background-color: #e9ecef;
            color: #555;
            border: none;
            box-shadow: none;
        }
        .empty {
            background-color: var(--input-bg-color);
        }
        .empty.invalid {
            background-color: var(--invalid-input-bg);
            border: 2px solid red;
        }
        .empty.correct {
            background-color: var(--valid-input-bg);
            border: 2px solid green;
        }

        input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            background: transparent;
            outline: none;
            color: var(--text-color);
        }
        
        .level-select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
        }

        .ad-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            gap: 20px;
            font-size: 1.5rem;
            text-align: center;
        }

        #real-ad-container {
            background: white;
            padding: 10px;
            max-width: 90%;
            width: 320px;
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .ad-button {
            padding: 10px 20px;
            background-color: #ffc107;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="title"></h1>

    <div id="auth-screen" class="screen">
        <h2 id="auth-title"></h2>
        <div id="auth-status-message"></div>
        <form id="auth-form" class="auth-form">
            <input type="email" id="auth-email" placeholder="Correo electr√≥nico" required>
            <input type="password" id="auth-password" placeholder="Contrase√±a" required>
            <button class="menu-button" type="submit" id="auth-submit-button"></button>
        </form>
        <button class="menu-button secondary-button" id="switch-auth-mode-button"></button>
        <button class="menu-button secondary-button" id="auth-back-button"></button>
    </div>

    <div id="main-menu" class="screen">
        <p id="welcome-message"></p>
        <button class="menu-button" id="play-button"></button>
        <button class="menu-button" id="stats-button"></button>
        <button class="menu-button" id="settings-button"></button>
        <button class="menu-button secondary-button" id="logout-button"></button>
    </div>

    <div id="level-select-screen" class="screen">
        <h2 id="level-select-title"></h2>
        <div class="level-select-grid">
            <button class="level-button" data-difficulty="easy" id="easy-level-button"></button>
            <button class="level-button" data-difficulty="medium" id="medium-level-button"></button>
            <button class="level-button" data-difficulty="hard" id="hard-level-button"></button>
            <button class="level-button" data-difficulty="expert" id="expert-level-button"></button>
            <button class="level-button" data-difficulty="threeDigit" id="three-digit-button"></button>
            <button class="level-button" data-difficulty="infinite" id="infinite-level-button"></button>
        </div>
        <button class="menu-button secondary-button" id="back-from-levels-button"></button>
    </div>

    <div id="game-screen" class="screen">
        <p id="game-info"></p>
        <div id="game-board"></div>
        <div id="result-message"></div>
        <button class="menu-button" id="check-button"></button>
        <button class="menu-button secondary-button" id="back-to-menu-button"></button>
    </div>

    <div id="stats-screen" class="screen">
        <div id="stats-container">
            <h2 id="stats-title"></h2>
            <p id="games-completed"></p>
            <p id="success-rate"></p>
            <p id="average-time"></p>
            <p id="levels-completed"></p>
        </div>
        <div id="badges-container">
            <h2 id="badges-title"></h2>
            <div id="badges-list"></div>
        </div>
        <button class="menu-button secondary-button" id="back-from-stats-button"></button>
    </div>

    <div id="settings-screen" class="screen">
        <label id="language-label" for="language-select"></label>
        <select id="language-select"></select>
        
        <p id="purchase-instruction" class="purchase-instruction"></p>
        
        <button class="menu-button" id="premium-button"></button>
        <p id="premium-status"></p>
     
        <div id="sync-data-section">
            <h3 id="sync-title">Sincronizaci√≥n Multi-Dispositivo</h3>
            <p style="font-size: 0.9em; text-align: center;">Ingresa tu PIN de 6 d√≠gitos para guardar o cargar tu progreso y Premium.</p>
            <input type="number" id="sync-input" placeholder="Introduce tu PIN de 6 d√≠gitos" maxlength="6" pattern="[0-9]{6}">
            <button class="menu-button" id="export-button">1. Exportar (Guardar)</button>
            <button class="menu-button secondary-button" id="import-button">2. Importar (Cargar)</button>
            <div id="sync-message" class="warning-note" style="display: none;"></div>
        </div>
       
        <div id="reset-data-section">
            <h3 id="reset-title"></h3>
            <button class="menu-button secondary-button" id="clear-progress-button"></button>
            <button class="menu-button secondary-button" id="reset-all-button"></button>
            <p id="reset-all-note" class="warning-note"></p>
        </div>

        <div id="delete-account-section">
            <h3 id="account-management-title"></h3>
            <p id="current-user-display"></p>
            <button class="menu-button secondary-button" id="delete-account-button"></button>
            <p id="reimbursement-note" class="warning-note"></p>
        </div>

        <button class="menu-button secondary-button" id="back-from-settings-button"></button>
    </div>
</div>

<div id="ad-popup" class="ad-screen" style="display: none;">
    <p id="ad-message"></p>
    <div id="real-ad-container"></div>
    <button class="ad-button" id="skip-ad-button"></button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
<script>
    // -----------------------------------------------------------
    // L√ìGICA PRINCIPAL DEL JUEGO
    // -----------------------------------------------------------
    
    // Variables globales
    let db;
    let app;

    const GUMROAD_PAYMENT_URL = "https://anacristinacz.gumroad.com/l/rnlle";
    const translations = {
        es: {
            mainMenu: 'Men√∫ Principal', play: 'Jugar', viewStats: 'Ver Estad√≠sticas', settings: 'Configuraci√≥n',
            levelCompleted: '¬°Nivel Completado!', incorrect: 'Incorrecto. ¬°Sigue intentando!',
            fillAllFields: 'Por favor, rellena todas las casillas.',
            gamesCompleted: 'Juegos Completados: {count}', successRate: 'Tasa de √âxito: {rate}', averageTime: 'Tiempo Promedio: {time}',
            badges: 'Insignias', unlocked: 'Desbloqueadas',
            firstTriumph: 'Primer Triunfo', firstTriumphDesc: 'Completa tu primer nivel',
            speedDemon: 'Demonio de la Velocidad', speedDemonDesc: 'Completa un nivel en menos de 30 segundos',
            perfectionist: 'Perfeccionista', perfectionistDesc: 'Completa 5 niveles sin usar pistas',
            mathematician: 'Matem√°tico', mathematicianDesc: 'Completa 10 niveles',
            backToMenu: 'Volver al Men√∫', language: 'Idioma', selectLevel: 'Selecciona un Nivel',
            easy: 'F√°cil', medium: 'Medio', hard: 'Dif√≠cil', expert: 'Experto',
            threeDigitNumbers: 'N√∫meros de 3 Cifras', infinite: 'Infinito',
            check: 'Comprobar',
            removeAds: 'Eliminar Anuncios', 
            premiumPrice: 'USD $174.00', 
            adMessage: 'Patrocinado: Espera unos segundos mientras cargamos el siguiente puzzle.',
            adSkip: 'Continuar al Siguiente Puzzle',
            premiumPurchased: '¬°Premium Activo! Disfruta sin anuncios.',
            premiumPurchaseFailed: 'Compra no registrada. Si ya pagaste, haz clic en el enlace de activaci√≥n que recibiste en Gumroad.',
            adSupported: 'Con Anuncios',
            loginTitle: 'Iniciar Sesi√≥n', registerTitle: 'Crear Cuenta',
            loginButton: 'Iniciar Sesi√≥n', registerButton: 'Registrarme',
            loginSwitch: '¬øNo tienes cuenta? Reg√≠strate', registerSwitch: '¬øYa tienes cuenta? Inicia Sesi√≥n',
            authSuccess: '¬°Bienvenido(a)!', authFailed: 'Credenciales inv√°lidas.',
            userExists: 'El correo ya est√° registrado.', registrationSuccess: 'Cuenta creada. ¬°Inicia Sesi√≥n!',
            logout: 'Cerrar Sesi√≥n', welcome: '¬°Hola, {user}!',
            accountManagement: 'Gesti√≥n de Cuenta', deleteAccount: 'Eliminar Cuenta',
            currentUser: 'Sesi√≥n activa: {user}',
            deleteConfirm: '¬øEst√°s seguro de que quieres ELIMINAR tu cuenta? Esta acci√≥n es PERMANENTE y borrar√° tu progreso y estad√≠sticas guardadas.',
            deleteSuccess: 'Tu cuenta ha sido eliminada. Todos los datos locales han sido borrados.',
            reimbursementNote: 'NOTA: La eliminaci√≥n de la cuenta no conlleva el reembolso del dinero pagado por la membres√≠a Premium.',
            authBack: 'Volver al Inicio',
            purchaseInstruction: 'IMPORTANTE: Para activar el Premium, la compra debe hacerse con el MISMO correo electr√≥nico que usas para iniciar sesi√≥n en este juego.',
            resetTitle: 'Restablecer Datos Locales',
            clearProgress: 'Borrar Progreso del Juego',
            clearProgressConfirm: '¬øEst√°s seguro de que quieres borrar tus estad√≠sticas y progreso de puzzle actual? ¬°El Premium se MANTENDR√Å!',
            resetAll: 'Borrar TODO (Progreso y Premium)',
            resetAllConfirm: 'ADVERTENCIA: ¬øEst√°s seguro de que quieres borrar TODOS los datos, incluyendo tu estado PREMIUM? Perder√°s el beneficio de no tener anuncios.',
            resetAllNote: 'Al borrar tus datos y tu estado Premium, el beneficio de no tener anuncios se perder√°. ESTE JUEGO NO OFRECE REEMBOLSOS por membres√≠as ya compradas.',
            progressCleared: 'Progreso de juego (estad√≠sticas y puzzles) borrado.',
            allDataReset: 'Todos los datos (progreso y estado Premium) han sido borrados.',
            syncError: 'Error: El PIN debe tener 6 d√≠gitos y la cuenta debe estar activa.',
            syncSuccessExport: '√âXITO: Progreso guardado en la nube con PIN {pin}.',
            syncSuccessImport: '√âXITO: Datos cargados. La p√°gina se actualizar√°.',
            syncErrorNotFound: 'ERROR: No se encontraron datos para ese PIN o el PIN es incorrecto.',
            syncErrorUserMismatch: 'ERROR: Los datos de este PIN no corresponden a tu usuario actual.'
        },
        en: {
            mainMenu: 'Main Menu', play: 'Play', viewStats: 'View Statistics', settings: 'Settings',
            levelCompleted: 'Level Completed!', incorrect: 'Incorrect. Keep trying!',
            fillAllFields: 'Please fill all fields.',
            gamesCompleted: 'Games Completed: {count}', successRate: 'Success Rate: {rate}', averageTime: 'Average Time: {time}',
            badges: 'Badges', unlocked: 'Unlocked',
            firstTriumph: 'First Triumph', firstTriumphDesc: 'Complete your first level',
            speedDemon: 'Speed Demon', speedDemonDesc: 'Complete a level in less than 30 seconds',
            perfectionist: 'Perfectionist', perfectionistDesc: 'Complete 5 levels without using hints',
            mathematician: 'Mathematician', mathematicianDesc: 'Complete 10 levels',
            backToMenu: 'Back to Menu', language: 'Language', selectLevel: 'Select a Level',
            easy: 'Easy', medium: 'Medium', hard: 'Hard', expert: 'Expert',
            threeDigitNumbers: '3-Digit Numbers', infinite: 'Infinite',
            check: 'Check',
            removeAds: 'Remove Ads', 
            premiumPrice: 'USD $174.00', 
            adMessage: 'Sponsored: Please wait while we load the next puzzle.',
            adSkip: 'Continue to Next Puzzle',
            premiumPurchased: 'Premium Active! Enjoy ad-free playing.',
            premiumPurchaseFailed: 'Purchase not registered. If you already paid, please click the activation link you received from Gumroad.',
            adSupported: 'Ad Supported',
            purchaseInstruction: 'IMPORTANT: To activate Premium benefits, the purchase must be made using the SAME email address you use to log into this game.',
            loginTitle: 'Log In', registerTitle: 'Create Account',
            loginButton: 'Log In', registerButton: 'Sign Up',
            loginSwitch: "Don't have an account? Sign Up", registerSwitch: 'Already have an account? Log In',
            authSuccess: 'Welcome back!', authFailed: 'Invalid credentials.',
            userExists: 'Email is already registered.', registrationSuccess: 'Account created. Please log in!',
            logout: 'Log Out', welcome: 'Hello, {user}!',
            accountManagement: 'Account Management', deleteAccount: 'Delete Account',
            currentUser: 'Active session: {user}',
            deleteConfirm: 'Are you sure you want to DELETE your account? This action is PERMANENT and will erase your saved progress and statistics.',
            deleteSuccess: 'Your account has been deleted. All local data has been erased.',
            reimbursementNote: 'NOTE: Account deletion does not automatically trigger a refund for the Premium membership.',
            authBack: 'Back to Home',
            resetTitle: 'Reset Local Data',
            clearProgress: 'Clear Game Progress',
            clearProgressConfirm: 'Are you sure you want to clear your stats and current puzzle progress? Premium status will be KEPT!',
            resetAll: 'Reset ALL Data (Progress & Premium)',
            resetAllConfirm: 'WARNING: Are you sure you want to delete ALL data, including your PREMIUM status? You will lose the ad-free benefit.',
            resetAllNote: 'Clearing all data, including your Premium status, means you will lose the ad-free benefit. THIS GAME DOES NOT OFFER REFUNDS for memberships already purchased.',
            progressCleared: 'Game progress (stats and puzzles) cleared.',
            allDataReset: 'All data (progress and Premium status) has been reset.',
            syncError: 'Error: PIN must be 6 digits and account must be active.',
            syncSuccessExport: 'SUCCESS: Progress saved in the cloud with PIN {pin}.',
            syncSuccessImport: 'SUCCESS: Data loaded. The page will update.',
            syncErrorNotFound: 'ERROR: No data found for that PIN or PIN is incorrect.',
            syncErrorUserMismatch: "ERROR: This PIN data does not belong to your current user."
        }
    };
    const languageNames = {
        es: 'Espa√±ol', en: 'English', fr: 'Fran√ßais', de: 'Deutsch', pt: 'Portugu√™s', it: 'Italiano'
    };
    const screens = {
        'auth-screen': document.getElementById('auth-screen'), 
        'main-menu': document.getElementById('main-menu'),
        'level-select-screen': document.getElementById('level-select-screen'),
        'game-screen': document.getElementById('game-screen'),
        'stats-screen': document.getElementById('stats-screen'),
        'settings-screen': document.getElementById('settings-screen')
    };
    const elements = {
        title: document.getElementById('title'),
        playButton: document.getElementById('play-button'),
        statsButton: document.getElementById('stats-button'),
        settingsButton: document.getElementById('settings-button'),
        authTitle: document.getElementById('auth-title'),
        authEmail: document.getElementById('auth-email'),
        authPassword: document.getElementById('auth-password'),
        authSubmitButton: document.getElementById('auth-submit-button'),
        authStatusMessage: document.getElementById('auth-status-message'),
        switchAuthModeButton: document.getElementById('switch-auth-mode-button'),
        authBackButton: document.getElementById('auth-back-button'),
        logoutButton: document.getElementById('logout-button'),
        welcomeMessage: document.getElementById('welcome-message'),
        accountManagementTitle: document.getElementById('account-management-title'),
        currentUserDisplay: document.getElementById('current-user-display'),
        deleteAccountButton: document.getElementById('delete-account-button'),
        reimbursementNote: document.getElementById('reimbursement-note'),
        resetTitle: document.getElementById('reset-title'),
        clearProgressButton: document.getElementById('clear-progress-button'),
        resetAllButton: document.getElementById('reset-all-button'),
        resetAllNote: document.getElementById('reset-all-note'),
        syncInput: document.getElementById('sync-input'),
        exportButton: document.getElementById('export-button'),
        importButton: document.getElementById('import-button'),
        syncMessage: document.getElementById('sync-message'),
        levelSelectTitle: document.getElementById('level-select-title'),
        levelButtons: document.querySelectorAll('.level-button'),
        gameBoard: document.getElementById('game-board'),
        resultMessage: document.getElementById('result-message'),
        checkButton: document.getElementById('check-button'),
        backToMenuButton: document.getElementById('back-to-menu-button'),
        backFromLevelsButton: document.getElementById('back-from-levels-button'),
        backFromStatsButton: document.getElementById('back-from-stats-button'),
        backFromSettingsButton: document.getElementById('back-from-settings-button'),
        languageSelect: document.getElementById('language-select'),
        languageLabel: document.getElementById('language-label'),
        gamesCompleted: document.getElementById('games-completed'),
        successRate: document.getElementById('success-rate'),
        averageTime: document.getElementById('average-time'),
        badgesTitle: document.getElementById('badges-title'),
        badgesList: document.getElementById('badges-list'),
        premiumButton: document.getElementById('premium-button'),
        premiumStatus: document.getElementById('premium-status'),
        adPopup: document.getElementById('ad-popup'),
        adMessage: document.getElementById('ad-message'),
        skipAdButton: document.getElementById('skip-ad-button'),
        realAdContainer: document.getElementById('real-ad-container'), 
        purchaseInstruction: document.getElementById('purchase-instruction')
    };
    let boardState = [];
    let solution = [];
    let currentLang = 'es';
    let isPremium = false; 
    let currentAuthMode = 'login';
    let currentUserID = null; 
    let stats = {
        gamesCompleted: 0,
        gamesCorrect: 0,
        totalTime: 0,
        badges: []
    };
    let difficultySettings = {
        level: 'easy'
    };
    const badges = [
        { id: 'firstTriumph', desc: 'firstTriumphDesc' },
        { id: 'speedDemon', desc: 'speedDemonDesc' },
        { id: 'perfectionist', desc: 'perfectionistDesc' },
        { id: 'mathematician', desc: 'mathematicianDesc' }
    ];
    const USER_DATA_PREFIX = 'crossmath_user_';

    function getLocalAccountData(email) {
        const data = localStorage.getItem(USER_DATA_PREFIX + email);
        return data ? JSON.parse(data) : null;
    }

    function saveLocalAccountData(email, data) {
        localStorage.setItem(USER_DATA_PREFIX + email, JSON.stringify(data));
    }

    function removeLocalAccountData(email) {
        localStorage.removeItem(USER_DATA_PREFIX + email);
    }

    function saveCurrentUserState() {
        if (currentUserID) {
            const currentData = getLocalAccountData(currentUserID) || {};
            saveLocalAccountData(currentUserID, {
                password: currentData.password, 
                stats: stats,
                isPremium: isPremium,
                boardState: boardState,
                solution: solution,
                difficultySettings: difficultySettings
            });
        }
    }

    function loadCurrentUserState(email) {
        const userData = getLocalAccountData(email);
        if (userData) {
            stats = userData.stats || { gamesCompleted: 0, gamesCorrect: 0, totalTime: 0, badges: [] };
            isPremium = userData.isPremium || false;
            boardState = userData.boardState || [];
            solution = userData.solution || [];
            difficultySettings = userData.difficultySettings || { level: 'easy' };
        } else {
            stats = { gamesCompleted: 0, gamesCorrect: 0, totalTime: 0, badges: [] };
            isPremium = false;
            boardState = [];
            solution = [];
            difficultySettings = { level: 'easy' };
        }
        currentUserID = email;
        localStorage.removeItem('crossmath_stats');
        localStorage.removeItem('crossmath_isPremium');
        localStorage.removeItem('crossmath_boardState');
        localStorage.removeItem('crossmath_solution');
        localStorage.removeItem('crossmath_difficulty');
    }
    
    function updateAuthScreenUI() {
        const t = translations[currentLang];
        elements.authTitle.textContent = currentAuthMode === 'login' ? t.loginTitle : t.registerTitle;
        elements.authSubmitButton.textContent = currentAuthMode === 'login' ? t.loginButton : t.registerButton;
        elements.switchAuthModeButton.textContent = currentAuthMode === 'login' ? t.loginSwitch : t.registerSwitch;
        elements.authStatusMessage.textContent = '';
        elements.authEmail.value = '';
        elements.authPassword.value = '';
    }

    function deleteLocalProgress() {
        const t = translations[currentLang];
        if (confirm(t.clearProgressConfirm)) {
            stats = { gamesCompleted: 0, gamesCorrect: 0, totalTime: 0, badges: [] };
            boardState = [];
            solution = [];
            saveCurrentUserState();
            alert(t.progressCleared);
            updateStatsView();
            updateMainMenuUI();
        }
    }

    function resetAllData() {
        const t = translations[currentLang];
        if (confirm(t.resetAllConfirm)) {
            stats = { gamesCompleted: 0, gamesCorrect: 0, totalTime: 0, badges: [] };
            boardState = [];
            solution = [];
            isPremium = false; 
            saveCurrentUserState();
            alert(t.allDataReset);
            updateStatsView();
            updateMainMenuUI();
            updatePremiumView();
        }
    }
    
    async function saveToExternalDB(pin, data) {
        await db.collection("SyncCodes").doc(pin).set(data);
    }

    async function loadFromExternalDB(pin) {
        const docRef = db.collection("SyncCodes").doc(pin);
        const docSnap = await docRef.get();
        if (docSnap.exists) {
            return docSnap.data();
        } else {
            return null;
        }
    }
    
    async function exportUserData() {
        const pin = elements.syncInput.value.trim();
        if (!currentUserID || pin.length !== 6 || isNaN(pin)) {
            elements.syncMessage.textContent = translations[currentLang].syncError;
            elements.syncMessage.style.display = 'block';
            return;
        }

        elements.syncMessage.textContent = 'Guardando en la nube...';
        elements.syncMessage.style.display = 'block';

        try {
            const dataToSync = {
                userId: currentUserID,
                stats: stats,
                isPremium: isPremium,
                difficultySettings: difficultySettings
            };
            await saveToExternalDB(pin, dataToSync);
            elements.syncMessage.textContent = translations[currentLang].syncSuccessExport.replace('{pin}', pin);
            elements.syncInput.value = '';
        } catch (e) {
            elements.syncMessage.textContent = "Error de exportaci√≥n: " + e.message;
            elements.syncMessage.style.display = 'block';
        }
    }

    async function importUserData() {
        const pin = elements.syncInput.value.trim();
        if (pin.length !== 6 || isNaN(pin)) {
            elements.syncMessage.textContent = translations[currentLang].syncError;
            elements.syncMessage.style.display = 'block';
            return;
        }

        elements.syncMessage.textContent = 'Cargando datos...';
        elements.syncMessage.style.display = 'block';
        try {
            const importedData = await loadFromExternalDB(pin);
            if (!importedData) {
                elements.syncMessage.textContent = translations[currentLang].syncErrorNotFound;
                return;
            }

            if (importedData.userId !== currentUserID) {
                 elements.syncMessage.textContent = translations[currentLang].syncErrorUserMismatch;
                return;
            }

            stats = importedData.stats;
            isPremium = importedData.isPremium;
            difficultySettings = importedData.difficultySettings;
            
            saveCurrentUserState();
            elements.syncMessage.textContent = translations[currentLang].syncSuccessImport;
            
            setTimeout(() => {
                window.location.reload(); 
            }, 500);
        } catch (e) {
            elements.syncMessage.textContent = "Error de importaci√≥n: " + e.message;
            elements.syncMessage.style.display = 'block';
        }
    }

    function updatePremiumView() {
        const t = translations[currentLang];
        if (isPremium) {
            elements.premiumButton.style.display = 'none';
            elements.premiumStatus.textContent = t.premiumPurchased;
            elements.premiumStatus.style.color = 'green';
        } else {
            elements.premiumButton.style.display = 'block';
            elements.premiumButton.textContent = `${t.removeAds} (${t.premiumPrice})`;
            elements.premiumStatus.textContent = t.adSupported;
            elements.premiumStatus.style.color = 'gray';
        }
    }

    function updateMainMenuUI() {
        const t = translations[currentLang];
        if (currentUserID) {
            elements.welcomeMessage.textContent = t.welcome.replace('{user}', currentUserID);
            elements.logoutButton.style.display = 'block';
            if (boardState.length > 0) {
                const difficultyKey = difficultySettings.level;
                elements.playButton.textContent = `${t.play} (${t[difficultyKey] || difficultyKey}) - Continuar`;
            } else {
                 elements.playButton.textContent = t.play;
            }
        } else {
            elements.welcomeMessage.textContent = '';
            elements.logoutButton.style.display = 'none';
        }
    }

    function updateSettingsUI() {
        const t = translations[currentLang];
        elements.accountManagementTitle.textContent = t.accountManagement;
        elements.currentUserDisplay.textContent = t.currentUser.replace('{user}', currentUserID);
        elements.deleteAccountButton.textContent = t.deleteAccount;
        elements.reimbursementNote.textContent = t.reimbursementNote;
        elements.purchaseInstruction.textContent = t.purchaseInstruction;
        elements.resetTitle.textContent = t.resetTitle;
        elements.clearProgressButton.textContent = t.clearProgress;
        elements.resetAllButton.textContent = t.resetAll;
        elements.resetAllNote.textContent = t.resetAllNote;
        elements.syncMessage.style.display = 'none';
    }

    function setLanguage(lang) {
        currentLang = lang;
        const t = translations[currentLang];
        elements.title.textContent = t.mainMenu;
        elements.statsButton.textContent = t.viewStats;
        elements.settingsButton.textContent = t.settings;
        elements.checkButton.textContent = t.check;
        elements.backToMenuButton.textContent = t.backToMenu;
        elements.backFromLevelsButton.textContent = t.backToMenu;
        elements.backFromStatsButton.textContent = t.backToMenu;
        elements.backFromSettingsButton.textContent = t.backToMenu;
        elements.languageLabel.textContent = t.language;
        elements.levelSelectTitle.textContent = t.selectLevel;
        elements.badgesTitle.textContent = t.badges;
        elements.authBackButton.textContent = t.authBack;
        
        elements.levelButtons.forEach(button => {
            const difficulty = button.dataset.difficulty;
            if (t[difficulty]) {
                button.textContent = t[difficulty];
            }
        });
        updateStatsView();
        updatePremiumView();
        updateAuthScreenUI();
        updateMainMenuUI();
        updateSettingsUI();
    }

    function switchScreen(screenId) {
        for (const id in screens) {
            screens[id].classList.remove('active');
        }
        screens[screenId].classList.add('active');

        if (screenId === 'stats-screen') {
            updateStatsView();
        }
        if (screenId === 'settings-screen') {
            updateSettingsUI();
            updatePremiumView();
        }
        if (screenId === 'auth-screen') {
            updateAuthScreenUI();
        }
        if (screenId === 'main-menu') {
            updateMainMenuUI();
        }
    }

    function updateStatsView() {
        const t = translations[currentLang];
        elements.gamesCompleted.textContent = t.gamesCompleted.replace('{count}', stats.gamesCompleted);
        const rate = stats.gamesCompleted > 0 ? ((stats.gamesCorrect / stats.gamesCompleted) * 100).toFixed(0) + '%' : '0%';
        elements.successRate.textContent = t.successRate.replace('{rate}', rate);
        const avgTime = stats.gamesCorrect > 0 ? (stats.totalTime / stats.gamesCorrect).toFixed(1) + 's' : '0s';
        elements.averageTime.textContent = t.averageTime.replace('{time}', avgTime);
        
        elements.badgesList.innerHTML = '';
        badges.forEach(badge => {
            const badgeItem = document.createElement('div');
            badgeItem.classList.add('badge-item');
            const icon = document.createElement('span');
            icon.classList.add('badge-icon');
            icon.textContent = stats.badges.includes(badge.id) ? 'üèÜ' : 'üîí';
            const text = document.createElement('span');
            text.textContent = `${translations[currentLang][badge.id]} - ${translations[currentLang][badge.desc]}`;
            badgeItem.appendChild(icon);
            badgeItem.appendChild(text);
            elements.badgesList.appendChild(badgeItem);
        });
    }

    function saveGameState() {
        saveCurrentUserState();
    }
    
    function loadGameState() {
        const savedUserID = localStorage.getItem('crossmath_active_user');
        if (savedUserID) {
            loadCurrentUserState(savedUserID);
            return true;
        } 
        
        const savedStats = localStorage.getItem('crossmath_stats');
        if (savedStats) {
            stats = JSON.parse(savedStats);
        }
        const savedPremium = localStorage.getItem('crossmath_isPremium');
        isPremium = savedPremium === 'true';
        
        return false;
    }

    function checkBadges() {
        if (stats.gamesCompleted >= 1 && !stats.badges.includes('firstTriumph')) {
            stats.badges.push('firstTriumph');
        }
        if (stats.gamesCorrect >= 5 && !stats.badges.includes('perfectionist')) {
            stats.badges.push('perfectionist');
        }
        if (stats.gamesCorrect >= 10 && !stats.badges.includes('mathematician')) {
            stats.badges.push('mathematician');
        }
        saveGameState();
    }
    
    function safeCalculate(n1, op, n2) {
        n1 = Number(n1);
        n2 = Number(n2);
        switch (op) {
            case '+': return n1 + n2;
            case '-': return n1 - n2;
            case '*': return n1 * n2;
            case '/': return n1 / n2;
            default: return NaN;
        }
    }

    function showAd() {
        if (isPremium) {
            generatePuzzle();
            return;
        }

        elements.adMessage.textContent = translations[currentLang].adMessage;
        elements.skipAdButton.textContent = translations[currentLang].adSkip;
        elements.adPopup.style.display = 'flex';
        elements.realAdContainer.innerHTML = `
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-6018346455368636"
                 data-ad-slot="1234567890" 
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        `;
        try {
             (window.adsbygoogle = window.adsbygoogle || []).push({});
        } catch (e) {
            console.error("Error al cargar AdSense:", e);
        }

        const skipTimer = setTimeout(() => {
            elements.skipAdButton.click();
        }, 8000);

        elements.skipAdButton.onclick = () => {
            clearTimeout(skipTimer);
            elements.adPopup.style.display = 'none';
            elements.realAdContainer.innerHTML = '';
            generatePuzzle();
            elements.resultMessage.textContent = '';
            screens['game-screen'].classList.add('active');
        };

        screens['game-screen'].classList.remove('active');
    }

    function generatePuzzle() {
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const difficulty = difficultySettings.level;
        const numberRange = difficulty === 'threeDigit' ? [10, 99] :
                            difficulty === 'hard' ? [10, 50] :
                            difficulty === 'medium' ? [5, 20] : [1, 10];
        const allowedOps = difficulty === 'easy' ? ['+', '-'] : ['+', '-', '*', '/'];
        let validSolutionFound = false;
        let finalSolution = [];
        let attempts = 0;
        
        while (!validSolutionFound && attempts < 500) {
            attempts++;
            try {
                let h1_n1 = getRandomInt(numberRange[0], numberRange[1]);
                let h1_op = allowedOps[getRandomInt(0, allowedOps.length - 1)];
                let h1_n2 = getRandomInt(numberRange[0], numberRange[1]);
                if (h1_op === '/' && h1_n1 % h1_n2 !== 0) continue;
                let h1_res = safeCalculate(h1_n1, h1_op, h1_n2);
                if (!Number.isInteger(h1_res) || h1_res < 0) continue;

                let h2_n1 = getRandomInt(numberRange[0], numberRange[1]);
                let h2_op = allowedOps[getRandomInt(0, allowedOps.length - 1)];
                let h2_n2 = getRandomInt(numberRange[0], numberRange[1]);
                if (h2_op === '/' && h2_n1 % h2_n2 !== 0) continue;
                let h2_res = safeCalculate(h2_n1, h2_op, h2_n2);
                if (!Number.isInteger(h2_res) || h2_res < 0) continue;
                
                let v1_op = allowedOps[getRandomInt(0, allowedOps.length - 1)];
                let v1_res = safeCalculate(h1_n1, v1_op, h2_n1);
                if (!Number.isInteger(v1_res) || v1_res < 0) continue;

                let v2_op = allowedOps[getRandomInt(0, allowedOps.length - 1)];
                let v2_res = safeCalculate(h1_n2, v2_op, h2_n2);
                if (!Number.isInteger(v2_res) || v2_res < 0) continue;

                let v3_op = allowedOps[getRandomInt(0, allowedOps.length - 1)];
                let v3_res = safeCalculate(h1_res, v3_op, h2_res);
                if (!Number.isInteger(v3_res) || v3_res < 0) continue;
                
                let h3_op = allowedOps[getRandomInt(0, allowedOps.length - 1)];
                let h3_n1 = v1_res;
                let h3_n2 = v2_res;
                if (h3_op === '/' && h3_n1 % h3_n2 !== 0) continue;
                let h3_res = safeCalculate(h3_n1, h3_op, h3_n2);
                if (h3_res !== v3_res || !Number.isInteger(h3_res) || h3_res < 0) continue;
                
                finalSolution = [
                    [h1_n1, h1_op, h1_n2, '=', h1_res],
                    [v1_op, '', v2_op, '', v3_op],
                    [h2_n1, h2_op, h2_n2, '=', h2_res],
                    ['=', '', '=', '', '='],
                    [h3_n1, h3_op, h3_n2, '=', h3_res]
                ];
                validSolutionFound = true;
            } catch (e) {}
        }
        
        if (!validSolutionFound) {
            finalSolution = [
                [1, '+', 2, '=', 3],
                ['+', ' ', '+', ' ', '+'],
                [4, '+', 5, '=', 9],
                ['=', ' ', '=', ' ', '='],
                [5, '+', 7, '=', 12]
            ];
        }

        solution = finalSolution;
        let boardData = [];
        const numberCells = [
            {r: 0, c: 0}, {r: 0, c: 2}, {r: 0, c: 4},
            {r: 2, c: 0}, {r: 2, c: 2}, {r: 2, c: 4},
            {r: 4, c: 0}, {r: 4, c: 2}, {r: 4, c: 4}
        ];
        for (let i = numberCells.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [numberCells[i], numberCells[j]] = [numberCells[j], numberCells[i]];
        }

        const inputsToHide = difficulty === 'expert' ? 6 : difficulty === 'hard' ? 5 : difficulty === 'medium' ? 4 : 3;
        const inputPositions = numberCells.slice(0, inputsToHide);

        for (let r = 0; r < solution.length; r++) {
            let row = [];
            for (let c = 0; c < solution[r].length; c++) {
                const cellValue = solution[r][c];
                const isInput = inputPositions.some(pos => pos.r === r && pos.c === c);
                if (isInput) {
                    row.push({ type: 'input', val: '', solution: cellValue });
                } else if (typeof cellValue === 'number') {
                    row.push({ type: 'given', val: cellValue });
                } else if (cellValue === '=') {
                    row.push({ type: 'equals', val: '=' });
                } else if (typeof cellValue === 'string' && cellValue.trim() !== '') {
                    row.push({ type: 'op', val: cellValue });
                } else {
                     row.push({ type: 'empty-space', val: '' });
                }
            }
            boardData.push(row);
        }
        
        boardState = boardData;
        elements.gameBoard.style.gridTemplateColumns = `repeat(5, auto)`;
        renderBoard();
        saveGameState(); 
    }

    function renderBoard() {
        elements.gameBoard.innerHTML = '';
        boardState.forEach((row, rowIndex) => {
            row.forEach((cell, colIndex) => {
                const cellElement = document.createElement('div');
                cellElement.classList.add('cell');

                if (cell.type === 'input') {
                    const input = document.createElement('input');
                    input.type = "number";
                    input.value = cell.val; 
                    input.addEventListener('input', (e) => {
                        cell.val = e.target.value;
                        saveCurrentUserState(); 
                    });
                    cellElement.classList.add('empty');
                    cellElement.appendChild(input);
                } else if (cell.type === 'given') {
                    cellElement.classList.add('given');
                    cellElement.textContent = cell.val;
                } else if (cell.type === 'equals') {
                    cellElement.classList.add('equals');
                    cellElement.textContent = cell.val;
                } else if (cell.type === 'op') {
                    cellElement.classList.add('operand');
                    cellElement.textContent = cell.val;
                } else if (cell.type === 'empty-space') {
                    cellElement.style.visibility = 'hidden';
                    cellElement.style.border = 'none';
                    cellElement.style.boxShadow = 'none';
                }
                elements.gameBoard.appendChild(cellElement);
            });
        });
    }

    const isEquationCorrect = (equation) => {
        try {
            const [n1, op, n2, equals, res] = equation;
            if (op === '/' && Number(n2) === 0) return false;
            const result = safeCalculate(n1, op, n2); 
            return Number(result) === Number(res);
        } catch (e) {
            return false;
        }
    };

    function checkSolution() {
        const inputs = document.querySelectorAll('#game-board input');
        let allInputsFilled = true;
        inputs.forEach(input => {
            if (input.value.trim() === '') {
                allInputsFilled = false;
            }
        });

        if (!allInputsFilled) {
            elements.resultMessage.textContent = translations[currentLang].fillAllFields; 
            return;
        }

        const userBoard = JSON.parse(JSON.stringify(solution)); 
        let inputIndex = 0;
        boardState.forEach((row, rowIndex) => {
            row.forEach((cell, colIndex) => {
                if (cell.type === 'input') {
                    userBoard[rowIndex][colIndex] = inputs[inputIndex].value; 
                    inputIndex++;
                }
            });
        });

        const equations = [
            userBoard[0], userBoard[2], userBoard[4], 
            [userBoard[0][0], userBoard[1][0], userBoard[2][0], userBoard[3][0], userBoard[4][0]], 
            [userBoard[0][2], userBoard[1][2], userBoard[2][2], userBoard[3][2], userBoard[4][2]], 
            [userBoard[0][4], userBoard[1][4], userBoard[2][4], userBoard[3][4], userBoard[4][4]], 
        ];

        let allEquationsValid = true;
        equations.forEach(eq => {
            if (!isEquationCorrect(eq)) {
                allEquationsValid = false;
            }
        });

        if (allEquationsValid) {
            elements.resultMessage.textContent = translations[currentLang].levelCompleted;
            stats.gamesCompleted++;
            stats.gamesCorrect++;
            checkBadges();
            boardState = [];
            solution = [];
            saveCurrentUserState(); 

            setTimeout(() => {
                showAd();
            }, 1000);
        } else {
            elements.resultMessage.textContent = translations[currentLang].incorrect;
        }
    }
    
    function checkPaymentStatus() {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentConfirmed = urlParams.get('premium');
        const purchaseEmail = urlParams.get('user');
        const t = translations[currentLang];

        if (paymentConfirmed === 'true') {
            const savedUserID = localStorage.getItem('crossmath_active_user');

            if (savedUserID) {
                loadCurrentUserState(savedUserID);
                if (!isPremium) {
                    isPremium = true;
                    saveGameState(); 
                    alert(t.premiumPurchased); 
                }
            } else if (purchaseEmail) {
                localStorage.setItem('crossmath_pending_premium_user', purchaseEmail);
                alert("¬°Compra detectada! Por favor, inicia sesi√≥n con el correo " + purchaseEmail + " para activar el Premium.");
            } else {
                alert("¬°Compra detectada! Por favor, inicia sesi√≥n ahora y si el Premium no se activa, borra tu cach√© e int√©ntalo de nuevo.");
            }
            
            window.history.replaceState({}, document.title, window.location.pathname);
            return true; 
        } 
        return false;
    }

    // --- EVENT LISTENERS ---

    document.getElementById('auth-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = elements.authEmail.value;
        const password = elements.authPassword.value;
        const t = translations[currentLang];
        elements.authStatusMessage.style.color = 'red';

        if (currentAuthMode === 'register') {
            if (getLocalAccountData(email)) {
                elements.authStatusMessage.textContent = t.userExists;
            } else {
                saveLocalAccountData(email, { password: password, stats: null, isPremium: false });
                elements.authStatusMessage.textContent = t.registrationSuccess;
                elements.authStatusMessage.style.color = 'green';
                currentAuthMode = 'login';
                updateAuthScreenUI();
            }
        } else if (currentAuthMode === 'login') {
            const userData = getLocalAccountData(email);
            if (userData && userData.password === password) {
                localStorage.setItem('crossmath_active_user', email);
                loadCurrentUserState(email);
                
                const pendingUser = localStorage.getItem('crossmath_pending_premium_user');
                if (pendingUser === email) {
                    isPremium = true;
                    saveGameState();
                    localStorage.removeItem('crossmath_pending_premium_user');
                    alert(t.premiumPurchased);
                }
                
                elements.authStatusMessage.textContent = t.authSuccess;
                elements.authStatusMessage.style.color = 'green';
                
                switchScreen('main-menu');
                checkPaymentStatus(); 
            } else {
                elements.authStatusMessage.textContent = t.authFailed;
            }
        }
    });

    elements.switchAuthModeButton.addEventListener('click', () => {
        currentAuthMode = currentAuthMode === 'login' ? 'register' : 'login';
        updateAuthScreenUI();
    });

    elements.authBackButton.addEventListener('click', () => {
        if (currentUserID) {
            switchScreen('main-menu');
        } else {
            alert("Por favor, inicia sesi√≥n o crea una cuenta para continuar.");
        }
    });

    elements.logoutButton.addEventListener('click', () => {
        saveCurrentUserState(); 
        currentUserID = null;
        localStorage.removeItem('crossmath_active_user');
        switchScreen('auth-screen');
    });

    elements.deleteAccountButton.addEventListener('click', () => {
        const t = translations[currentLang];
        if (!currentUserID) return;
        
        if (confirm(t.deleteConfirm)) {
            removeLocalAccountData(currentUserID); 
            localStorage.removeItem('crossmath_active_user');
            alert(t.deleteSuccess);
            currentUserID = null;
            switchScreen('auth-screen'); 
        }
    });

    elements.clearProgressButton.addEventListener('click', deleteLocalProgress);
    elements.resetAllButton.addEventListener('click', resetAllData);
    elements.exportButton.addEventListener('click', exportUserData);
    elements.importButton.addEventListener('click', importUserData);

    elements.premiumButton.addEventListener('click', () => {
        if (!currentUserID) {
            alert("Por favor, inicia sesi√≥n para realizar la compra Premium.");
            return;
        }
        window.open(GUMROAD_PAYMENT_URL, '_blank');
        setTimeout(() => {
            alert("Ser√°s redirigido a Gumroad. Una vez que pagues, haz clic en el enlace que te aparecer√° para activar el Premium.");
        }, 500);
    });

    elements.backToMenuButton.addEventListener('click', () => {
        switchScreen('level-select-screen');
    });

    elements.playButton.addEventListener('click', () => {
        if (currentUserID && boardState.length > 0) {
            switchScreen('game-screen');
        } else if (currentUserID) {
            switchScreen('level-select-screen');
        } else {
            switchScreen('auth-screen');
        }
    });

    elements.statsButton.addEventListener('click', () => {
         if (currentUserID) {
            switchScreen('stats-screen');
        } else {
            switchScreen('auth-screen');
        }
    });

    elements.settingsButton.addEventListener('click', () => {
         if (currentUserID) {
            switchScreen('settings-screen');
        } else {
            switchScreen('auth-screen');
        }
    });

    elements.backFromLevelsButton.addEventListener('click', () => switchScreen('main-menu'));
    elements.backFromStatsButton.addEventListener('click', () => switchScreen('main-menu'));
    elements.backFromSettingsButton.addEventListener('click', () => switchScreen('main-menu'));
    elements.checkButton.addEventListener('click', checkSolution);

    elements.languageSelect.addEventListener('change', (e) => {
        setLanguage(e.target.value);
    });

    elements.levelButtons.forEach(button => {
        button.addEventListener('click', () => {
            difficultySettings.level = button.dataset.difficulty;
            switchScreen('game-screen');
            generatePuzzle();
        });
    });
    
    // --- INICIALIZACI√ìN DEL JUEGO ---
    
    document.addEventListener('DOMContentLoaded', () => {
        // CORRECCI√ìN 2: Mover la inicializaci√≥n de Firebase aqu√≠.
        const firebaseConfig = {
            apiKey: "AIzaSyCKIUkOfSMOLIhuYcQ30rm1Uc6hg8MFJ04",
            authDomain: "crossmath-sync-db.firebaseapp.com",
            projectId: "crossmath-sync-db",
            storageBucket: "crossmath-sync-db.firebasestorage.app",
            messagingSenderId: "170459630175",
            appId: "1:170459630175:web:6a2a4ccba5dad1fa0ee9ea",
            measurementId: "G-BBJKKN96SV"
        };
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();

        // Cargar los idiomas en el selector
        for (const langCode in languageNames) {
            const option = document.createElement('option');
            option.value = langCode;
            option.textContent = languageNames[langCode];
            elements.languageSelect.appendChild(option);
        }
        
        // Detectar idioma del navegador
        const browserLang = navigator.language.split('-')[0];
        if (translations[browserLang]) {
            currentLang = browserLang;
        }
        elements.languageSelect.value = currentLang;

        // Cargar estado del juego y decidir pantalla inicial
        const hasActiveUser = loadGameState();
        
        checkPaymentStatus(); 
        setLanguage(currentLang);
        
        if (hasActiveUser) {
            switchScreen('main-menu');
        } else {
            switchScreen('auth-screen');
        }
    });
</script>
</body>
</html>
